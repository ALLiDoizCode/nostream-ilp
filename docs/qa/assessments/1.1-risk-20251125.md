# Risk Profile: Story 1.1 - Fork Nostream and Remove Centralized Payments

**Story:** 1.1 - Fork Nostream and Remove Centralized Payments
**Assessment Date:** 2025-11-25
**Reviewer:** Quinn (Test Architect)

---

## Risk Summary

| Risk Category | Probability | Impact | Score | Status |
|---------------|-------------|--------|-------|--------|
| Build Failure | HIGH | HIGH | 9 | ðŸ”´ CRITICAL |
| Test Migration Incomplete | MEDIUM | MEDIUM | 6 | ðŸŸ¡ MONITOR |
| Runtime Security | LOW | HIGH | 4 | ðŸŸ¢ ACCEPTABLE |
| Database Migration | LOW | LOW | 2 | ðŸŸ¢ ACCEPTABLE |

**Overall Risk Score:** 9 (CRITICAL)
**Risk Level:** HIGH - One critical build risk requiring immediate attention

---

## Risk Details

### 1. Build Failure Risk (Score: 9) ðŸ”´ CRITICAL

**Risk:** TypeScript 4.6.4 cannot parse @types/node@22.19.1, causing fresh builds to fail

**Probability:** HIGH (100% on clean checkout)
**Impact:** HIGH (blocks deployment, CI/CD, new developer onboarding)

**Evidence:**
```
pnpm run build fails with 19 TypeScript errors:
- TS1005: ';' expected
- TS1109: Expression expected
- Errors in node_modules/@types/node/https.d.ts and stream/web.d.ts
```

**Current Mitigation:**
- Existing dist/ folder allows continued development
- Tests can run using pre-compiled output

**Recommended Mitigation:**
1. **Option A (Preferred):** Upgrade TypeScript 4.6.4 â†’ 5.3.0 (per tech-stack.md)
   - Aligns with project standards
   - Supports modern @types/node
   - May require minor code adjustments
2. **Option B (Quick fix):** Downgrade @types/node 22.19.1 â†’ 18.x
   - Matches Node.js 18 runtime
   - No code changes needed
   - Deviates from pnpm's latest resolution

**Must Fix Before:** Story 1.2 development begins

---

### 2. Test Migration Incomplete (Score: 6) ðŸŸ¡ MONITOR

**Risk:** 32 legacy test files still use Chai/Sinon/Mocha instead of Vitest

**Probability:** MEDIUM (tests will fail when run)
**Impact:** MEDIUM (technical debt, inconsistent test framework)

**Evidence:**
```
test/unit/factories/*.spec.ts - 6 files import 'chai'
test/unit/repositories/*.spec.ts - 1 file imports 'chai'
test/unit/handlers/*.spec.ts - 1 file imports 'sinon'
... (32 total files affected)
```

**Current Mitigation:**
- New cleanup verification tests use Vitest correctly
- Legacy tests can be skipped in CI temporarily

**Recommended Mitigation:**
1. Create follow-up Story 1.1.1: "Migrate Legacy Tests to Vitest"
2. Migrate test files in batches:
   - Batch 1: Factories (6 files)
   - Batch 2: Repositories (1 file)
   - Batch 3: Handlers (25 files)
3. Remove Chai/Sinon dependencies after migration complete

**Timeline:** Address in Sprint 2 (non-blocking for Story 1.2)

---

### 3. Runtime Security Risk (Score: 4) ðŸŸ¢ ACCEPTABLE

**Risk:** Relay accepts all events without payment during transition period (Story 1.1 â†’ Story 1.4)

**Probability:** LOW (documented, operators warned)
**Impact:** HIGH (potential spam, resource exhaustion)

**Evidence:**
- `payments.enabled = false` in settings.json
- No payment verification in EVENT handler until Story 1.4
- MIGRATION.md documents "Temporary Open Relay Risk"

**Current Mitigation:**
- Comprehensive documentation in MIGRATION.md
- Security verification checklist provided for operators
- NIP-42 authentication still functional (independent of payment)

**Recommended Mitigation:**
1. Deploy behind IP allowlist during transition
2. Use aggressive rate limiting (see .nostr/settings.json)
3. Consider feature flag: `PAYMENTS_ENABLED=false` to disable relay until ILP ready

**Timeline:** Resolved in Story 1.4 (ILP payment verification)

---

### 4. Database Migration Risk (Score: 2) ðŸŸ¢ ACCEPTABLE

**Risk:** Database migration may fail if payment tables don't exist or have dependencies

**Probability:** LOW (migration uses IF EXISTS)
**Impact:** LOW (non-blocking, clean installs skip payment migrations)

**Evidence:**
```sql
-- Migration uses safe DROP IF EXISTS
DROP FUNCTION IF EXISTS charge_user(BYTEA, BIGINT);
DROP FUNCTION IF EXISTS confirm_invoice(...);
DROP TABLE IF EXISTS invoices;
DROP TABLE IF EXISTS users;
```

**Current Mitigation:**
- Migration uses `IF EXISTS` for idempotency
- Documentation notes clean installations should skip payment migrations
- No rollback implemented (intentional - cannot restore removed features)

**Recommended Mitigation:**
1. Test migration on clean database (no payment tables)
2. Test migration on populated database (with payment tables)
3. Document migration test results in MIGRATION.md

**Timeline:** Validation testing recommended before production deployment

---

## Risk Matrix

```
Impact
  HIGH â”‚  [3]      [1]
       â”‚
MEDIUM â”‚  [2]
       â”‚
   LOW â”‚           [4]
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Probability
         LOW  MEDIUM  HIGH

[1] Build Failure (9) - CRITICAL
[2] Test Migration (6) - MONITOR
[3] Runtime Security (4) - ACCEPTABLE
[4] Database Migration (2) - ACCEPTABLE
```

---

## Risk Mitigation Roadmap

### Immediate Actions (Before Story 1.2)
- [ ] Fix TypeScript version incompatibility (Risk #1)
- [ ] Verify clean build works: `pnpm clean && pnpm install && pnpm build`
- [ ] Update package.json with TypeScript 5.3.0 or @types/node 18.x

### Short-term Actions (Sprint 2)
- [ ] Create Story 1.1.1 for legacy test migration (Risk #2)
- [ ] Test database migration on clean and populated databases (Risk #4)
- [ ] Document operator security checklist in deployment guide (Risk #3)

### Long-term Monitoring
- [ ] Track test migration progress (32 files remaining)
- [ ] Monitor relay security during transition period (until Story 1.4)
- [ ] Review risk profile after Story 1.2 completion

---

## Conclusion

**Overall Risk Assessment:** HIGH (due to build failure risk)

**Recommendation:** Address critical TypeScript version incompatibility immediately. The 93% excellent implementation should not be blocked by a 7% dependency version mismatch.

**Gate Decision Impact:**
- Current Gate: CONCERNS (appropriate)
- Post-fix Gate: PASS (expected after TypeScript fix)

---

*Last Updated: 2025-11-25*
*Next Review: After TypeScript version fix*
