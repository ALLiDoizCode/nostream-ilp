# Risk Profile: Story 2.10 - Migrate Dassie into Monorepo

**Date:** 2025-12-13
**Reviewer:** Quinn (Test Architect)
**Story:** 2.10 - Migrate Dassie into Monorepo
**Epic:** 2 - Payment Infrastructure & Deployment

---

## Executive Summary

- **Total Risks Identified:** 9
- **Critical Risks:** 1 (CI/CD not implemented)
- **High Risks:** 2 (Build failures, Docker deferred)
- **Medium Risks:** 4 (Test failures, dev validation, dependency resolution, git history)
- **Low Risks:** 2 (Performance regression, documentation drift)
- **Overall Risk Score:** 58/100 (Moderate Risk)

**Key Finding:** The monorepo migration is architecturally sound but has critical deployment blockers. Development can proceed, but production deployment requires completing deferred work (CI/CD, Docker).

---

## Critical Risks Requiring Immediate Attention

### 1. [OPS-001]: CI/CD Pipeline Not Implemented

**Score: 9 (Critical)**
**Probability:** High (3) - Task 10 explicitly deferred, no CI/CD configuration exists
**Impact:** High (3) - Cannot deploy to production, no automated quality gates, no release pipeline

**Description:**
Acceptance Criterion 10 requires CI/CD updates, but this work was deferred to a future story. Without CI/CD, the monorepo cannot be deployed to production environments, and there are no automated build/test gates to prevent broken code from merging.

**Affected Components:**
- `.github/workflows/` (no files exist or need updates)
- Root build scripts
- All 19 packages in workspace

**Mitigation Strategy:** Preventive + Detective

**Immediate Actions Required:**
1. Create `.github/workflows/ci.yml` with pnpm install, build, test, lint
2. Add matrix strategy to build each package independently
3. Configure pnpm caching for faster CI builds
4. Add status checks required for PR merges
5. Set up deployment workflows for staging/production

**Testing Requirements:**
- Test CI pipeline on feature branch before merging
- Validate pnpm workspace builds in CI environment
- Verify all 19 packages build successfully in CI
- Test caching strategy improves build times

**Residual Risk:** Low - Once CI/CD is implemented, automated gates will catch issues

**Owner:** DevOps / Dev Team
**Timeline:** **MUST complete before any production deployment**
**Blocking:** Stories 2.12 (Docker), 2.13 (Akash deployment)

---

## High Risks

### 2. [TECH-001]: lib-dassie-oer Build Failures

**Score: 6 (High)**
**Probability:** High (3) - Errors confirmed in QA review, currently failing
**Impact:** Medium (2) - Dassie OER encoding/decoding functionality broken, but core relay works

**Description:**
Pre-existing TypeScript compilation errors in `lib-dassie-oer` package:
- SafeUnsignedInteger type assertions missing (octet-string.ts)
- TextDecoder/TextEncoder type mismatches (string.ts)

**Affected Components:**
- `packages/lib-dassie-oer/src/octet-string.ts:216,229`
- `packages/lib-dassie-oer/src/string.ts` (TextDecoder/TextEncoder)
- Any packages depending on lib-dassie-oer

**Mitigation:**
1. Add SafeUnsignedInteger type assertions in octet-string.ts (similar to QA's lib-dassie-logger fixes)
2. Fix TextDecoder/TextEncoder types using `InstanceType<typeof T>` pattern
3. Run `pnpm --filter @nostream-ilp/lib-dassie-oer build` to verify
4. Add unit tests for OER encoding/decoding if missing

**Testing Requirements:**
- Unit tests for OER encode/decode functions
- Integration tests for ILP packet serialization
- Verify all dependent packages build after fix

**Residual Risk:** Low - TypeScript errors are straightforward to fix (QA already fixed similar issues in lib-dassie-logger)

**Owner:** Dev Team
**Timeline:** High priority - should be fixed before Story 2.11 (payment channels)

---

### 3. [OPS-002]: Docker Configuration Deferred

**Score: 6 (High)**
**Probability:** High (3) - Task 9 explicitly deferred to Story 2.12
**Impact:** Medium (2) - Cannot containerize services, blocks Akash deployment

**Description:**
Task 9 (Docker multi-stage builds for monorepo) was deferred to Story 2.12. Current Dockerfiles are not updated for the new monorepo structure and will fail to build.

**Affected Components:**
- `docker/Dockerfile.nostream` (needs monorepo context)
- `docker/Dockerfile.dassie` (doesn't exist yet)
- `docker-compose.yml` (outdated paths)

**Mitigation:**
1. Complete Story 2.12 before attempting any containerized deployments
2. Document Docker build requirements in Story 2.12
3. Test Docker builds locally before Akash deployment
4. Ensure multi-stage builds use pnpm workspace correctly

**Testing Requirements:**
- `docker-compose build` succeeds for both services
- `docker-compose up` starts services correctly
- Services can communicate (nostream → dassie RPC)
- Image sizes reasonable (<500MB compressed)

**Residual Risk:** Low - Docker configuration is well-documented in Dev Notes

**Owner:** Dev Team (Story 2.12 owner)
**Timeline:** Must complete before Story 2.13 (Akash deployment)
**Blocking:** Story 2.13 (Akash deployment)

---

## Medium Risks

### 4. [TECH-002]: Pre-Existing Test Failures

**Score: 4 (Medium)**
**Probability:** Medium (2) - Some tests failing, documented in Dev Agent Record
**Impact:** Medium (2) - Reduced confidence in functionality, potential bugs hidden

**Description:**
17 pre-existing test failures in app-nostream:
- 9 failures in `test/btp-nips/event-repository.spec.ts` (tag filtering, expiration)
- 3 failures in `test/btp-nips/peer-discovery/heartbeat-monitor.spec.ts` (PING/PONG timing)
- 5 failures in `test/btp-nips/peer-discovery/ilp-node-announcement.spec.ts` (publishing)

**Affected Components:**
- BTP-NIPs event repository (storage layer)
- Peer discovery heartbeat monitoring
- ILP node announcement publishing

**Mitigation:**
1. Investigate each failing test to determine if:
   - Test is incorrect (update test)
   - Implementation has regression (fix code)
   - Test environment issue (fix test setup)
2. Create separate tickets for each failing test
3. Prioritize fixes based on feature importance
4. Add to technical debt backlog if not critical

**Testing Requirements:**
- All 17 tests should pass
- Verify tests pass consistently (not flaky)
- Add additional tests if coverage gaps found

**Residual Risk:** Medium - Until tests are fixed, actual functionality status is unknown

**Owner:** Dev Team
**Timeline:** Should investigate before Story 2.11 (uses BTP-NIPs)

---

### 5. [OPS-003]: Dev Scripts Not Validated

**Score: 4 (Medium)**
**Probability:** Medium (2) - Scripts defined but not tested in story
**Impact:** Medium (2) - Developers may encounter runtime issues

**Description:**
AC 6 requires dev scripts (`pnpm dev:nostream`, `pnpm dev:dassie`, `pnpm dev:all`) to work, but story notes these weren't tested. Potential issues:
- Port conflicts between services
- Environment variable misconfigurations
- Missing runtime dependencies
- Incorrect paths in dev scripts

**Affected Components:**
- Root `package.json` dev scripts
- `packages/app-nostream/package.json` dev script
- `packages/app-dassie/package.json` dev script
- `concurrently` dependency

**Mitigation:**
1. Run `pnpm dev:nostream` and verify relay starts on correct port
2. Run `pnpm dev:dassie` and verify Dassie node starts
3. Run `pnpm dev:all` and verify both run concurrently without conflicts
4. Document any required environment variables
5. Add dev script validation to CI/CD smoke tests

**Testing Requirements:**
- Manual test: Start nostream, verify WebSocket connection
- Manual test: Start dassie, verify HTTP API responds
- Manual test: Both running, verify ILP packet routing
- Smoke test in CI: Scripts exit with code 0 (if --dry-run supported)

**Residual Risk:** Low - Dev scripts are straightforward to validate

**Owner:** Dev Team
**Timeline:** Before next developer onboarding or Epic 3 work begins

---

### 6. [TECH-003]: Workspace Dependency Resolution

**Score: 4 (Medium)**
**Probability:** Medium (2) - No smoke tests for workspace deps
**Impact:** Medium (2) - Could cause subtle import errors or version mismatches

**Description:**
No automated tests verify that workspace dependencies resolve correctly:
- `app-nostream` importing from `lib-payment-types`
- `app-dassie` importing from `lib-dassie-*` packages
- Circular dependency risks
- pnpm workspace protocol (`workspace:^`) correctness

**Affected Components:**
- All workspace packages with `workspace:^` dependencies
- TypeScript path resolution
- Build order (project references)

**Mitigation:**
1. Add smoke test that imports from each workspace package
2. Verify `pnpm list` shows correct dependency tree (no duplicates)
3. Test TypeScript path resolution: `tsc --noEmit` across all packages
4. Add integration test: app-nostream uses lib-payment-types types at runtime
5. Monitor for `Cannot find module '@nostream-ilp/*'` errors

**Testing Requirements:**
- Unit test: Import each exported type from lib-payment-types
- Integration test: app-nostream creates PaymentClaim object
- Build test: All packages build with project references
- Dependency audit: `pnpm list --depth=0` shows no duplicates

**Residual Risk:** Low - pnpm workspaces are well-tested, but custom config needs validation

**Owner:** Dev Team
**Timeline:** Add to next story touching workspace dependencies

---

### 7. [DATA-001]: Git History Preservation

**Score: 4 (Medium)**
**Probability:** Medium (2) - Copy approach used, not git subtree
**Impact:** Medium (2) - Dassie commit history may be lost, harder to trace bugs

**Description:**
AC 8 requires git history preservation using `git subtree` or `git filter-branch`, but story used copy approach. This means:
- Dassie commit history not in nostream-ilp repo
- Harder to use `git blame` on Dassie files
- Original authors not credited in monorepo history
- Regression investigation more difficult

**Affected Components:**
- All 18 Dassie packages copied from separate repo
- Git history for packages/app-dassie and packages/lib-dassie-*

**Mitigation:**
1. Document original Dassie commit SHA in Dev Agent Record (already done)
2. Keep link to original Dassie repo: https://github.com/justmoon/dassie
3. Add DASSIE_MIGRATION.md documenting:
   - Original repo location
   - Migration date and commit SHAs
   - How to find original commit history
4. Consider re-doing migration with `git subtree add` if history is critical
5. Add git commit message for migration commit with detailed context

**Testing Requirements:**
- Verify migration commit has detailed message
- Document original Dassie repo URL in README.md
- Create DASSIE_MIGRATION.md with history tracking info

**Residual Risk:** Medium - History is lost but documented; cannot be fully recovered without re-migration

**Owner:** Dev Team
**Timeline:** Document now; re-migration optional based on team decision

---

## Low Risks

### 8. [PERF-001]: Build Time Regression

**Score: 2 (Low)**
**Probability:** Low (1) - TypeScript project references enable incremental builds
**Impact:** Medium (2) - Slower developer feedback loop if build times increase significantly

**Description:**
Initial build time may increase due to 19 packages vs monolithic build, but subsequent builds should be faster with TypeScript incremental compilation.

**Affected Components:**
- All 19 packages
- TypeScript compilation
- pnpm workspace dependency resolution

**Mitigation:**
1. Measure baseline build time: `time pnpm build`
2. Monitor incremental build time after changes
3. Optimize if build time > 2 minutes:
   - Use `tsc --build` instead of `tsc` for project references
   - Add `composite: true` to all package tsconfig.json
   - Configure parallel builds: `pnpm -r --parallel build`
4. Document build times in MONOREPO.md

**Testing Requirements:**
- Benchmark: Fresh build time (cold cache)
- Benchmark: Incremental build time (1 file changed)
- Benchmark: Parallel build performance
- Target: Incremental builds < 10 seconds

**Residual Risk:** Very Low - TypeScript project references are designed for monorepos

**Owner:** Dev Team
**Timeline:** Monitor during normal development; optimize if needed

---

### 9. [OPS-004]: Documentation Drift

**Score: 2 (Low)**
**Probability:** Low (1) - Documentation was thoroughly updated in this story
**Impact:** Medium (2) - Could confuse new developers if docs become outdated

**Description:**
Risk that documentation (MONOREPO.md, README.md, source-tree-structure.md) becomes outdated as codebase evolves.

**Affected Components:**
- MONOREPO.md
- README.md
- docs/architecture/source-tree-structure.md
- Package-specific READMEs

**Mitigation:**
1. Add documentation review to story templates (check if docs need updates)
2. Add CODEOWNERS for documentation files
3. Include doc updates in CI/CD PR checklist
4. Schedule quarterly documentation review
5. Use automated tools (e.g., doctoc) for table of contents

**Testing Requirements:**
- PR checklist includes "Documentation updated if needed"
- CI fails if README.md out of date (automated check)
- Quarterly review calendar event

**Residual Risk:** Very Low - Mitigated by process and culture

**Owner:** All Contributors
**Timeline:** Ongoing (process improvement)

---

## Risk Distribution

### By Category

| Category | Total | Critical | High | Medium | Low |
|----------|-------|----------|------|--------|-----|
| Operational (OPS) | 4 | 1 | 1 | 2 | 0 |
| Technical (TECH) | 3 | 0 | 1 | 2 | 0 |
| Data (DATA) | 1 | 0 | 0 | 1 | 0 |
| Performance (PERF) | 1 | 0 | 0 | 0 | 1 |
| **Total** | **9** | **1** | **2** | **4** | **2** |

**Key Insight:** Operational risks dominate (CI/CD, Docker, dev scripts, docs) - expected for infrastructure story.

### By Component

| Component | Risks | Highest Score |
|-----------|-------|---------------|
| CI/CD Pipeline | 1 | 9 (Critical) |
| Docker Configuration | 1 | 6 (High) |
| lib-dassie-oer | 1 | 6 (High) |
| Test Suite | 1 | 4 (Medium) |
| Dev Scripts | 1 | 4 (Medium) |
| Workspace Dependencies | 1 | 4 (Medium) |
| Git History | 1 | 4 (Medium) |
| Build Performance | 1 | 2 (Low) |
| Documentation | 1 | 2 (Low) |

---

## Detailed Risk Register

| ID | Category | Title | Probability | Impact | Score | Priority | Status |
|----|----------|-------|-------------|--------|-------|----------|--------|
| OPS-001 | Operational | CI/CD Pipeline Not Implemented | High (3) | High (3) | 9 | **Critical** | Open |
| TECH-001 | Technical | lib-dassie-oer Build Failures | High (3) | Medium (2) | 6 | **High** | Open |
| OPS-002 | Operational | Docker Configuration Deferred | High (3) | Medium (2) | 6 | **High** | Deferred (Story 2.12) |
| TECH-002 | Technical | Pre-Existing Test Failures | Medium (2) | Medium (2) | 4 | Medium | Open |
| OPS-003 | Operational | Dev Scripts Not Validated | Medium (2) | Medium (2) | 4 | Medium | Open |
| TECH-003 | Technical | Workspace Dependency Resolution | Medium (2) | Medium (2) | 4 | Medium | Open |
| DATA-001 | Data | Git History Preservation | Medium (2) | Medium (2) | 4 | Medium | Documented |
| PERF-001 | Performance | Build Time Regression | Low (1) | Medium (2) | 2 | Low | Monitor |
| OPS-004 | Operational | Documentation Drift | Low (1) | Medium (2) | 2 | Low | Process |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Before Production)

**OPS-001: CI/CD Pipeline**
- **Test Type:** Integration, E2E
- **Test Scenarios:**
  1. GitHub Actions workflow installs pnpm correctly
  2. All 19 packages build in CI environment
  3. All tests pass in CI
  4. Linting passes for all packages
  5. Build artifacts are cached correctly
  6. PR status checks block merge if CI fails
  7. Deployment workflow triggers on main branch merge
- **Environment:** GitHub Actions (or equivalent CI/CD)
- **Success Criteria:** 100% CI pipeline coverage for build/test/lint/deploy

---

### Priority 2: High Risk Tests

**TECH-001: lib-dassie-oer Build Failures**
- **Test Type:** Unit, Integration
- **Test Scenarios:**
  1. OER octet string encoding with SafeUnsignedInteger values
  2. OER octet string decoding returns correct types
  3. TextDecoder/TextEncoder instantiation
  4. ILP packet serialization using OER encoding
  5. All dependent packages import lib-dassie-oer without errors
- **Environment:** Local development, CI
- **Success Criteria:** `pnpm --filter @nostream-ilp/lib-dassie-oer build` exits 0

**OPS-002: Docker Configuration**
- **Test Type:** Integration, E2E
- **Test Scenarios:**
  1. Multi-stage Docker build completes successfully
  2. Docker image size < 500MB compressed
  3. Container starts without errors
  4. Services expose correct ports
  5. Nostream → Dassie RPC communication works in Docker
  6. Environment variables passed correctly to containers
- **Environment:** Local Docker, Docker Compose
- **Success Criteria:** `docker-compose up` starts both services healthy

---

### Priority 3: Medium Risk Tests

**TECH-002: Pre-Existing Test Failures**
- Fix 17 failing tests across 3 files
- Verify tests pass consistently (run 10 times)
- Add missing test coverage if gaps identified

**OPS-003: Dev Scripts**
- Run `pnpm dev:nostream` manually, verify WebSocket works
- Run `pnpm dev:dassie` manually, verify HTTP API responds
- Run `pnpm dev:all`, verify no port conflicts
- Document required environment variables

**TECH-003: Workspace Dependencies**
- Add smoke test importing from all workspace packages
- Verify `pnpm list --depth=0` shows no duplicates
- Test TypeScript path resolution with `tsc --noEmit`

**DATA-001: Git History**
- Document original Dassie commit SHA
- Create DASSIE_MIGRATION.md with history tracking
- Add link to original Dassie repo in README

---

### Priority 4: Low Risk Tests

**PERF-001: Build Time**
- Benchmark fresh build: `time pnpm build`
- Benchmark incremental build: change 1 file, measure rebuild time
- Target: Incremental builds < 10 seconds

**OPS-004: Documentation Drift**
- Add doc review to PR checklist
- Schedule quarterly doc review

---

## Risk Acceptance Criteria

### Must Fix Before Production Deployment

1. **OPS-001: CI/CD Pipeline** (Score: 9)
   - Status: **BLOCKING** production deployment
   - Action: Create GitHub Actions workflows for build/test/deploy
   - Timeline: Before Story 2.13 (Akash deployment)

2. **TECH-001: lib-dassie-oer Build Failures** (Score: 6)
   - Status: **BLOCKING** Dassie functionality
   - Action: Fix TypeScript errors (SafeUnsignedInteger, TextDecoder/TextEncoder)
   - Timeline: Before Story 2.11 (payment channels)

3. **OPS-002: Docker Configuration** (Score: 6)
   - Status: **BLOCKING** containerized deployment
   - Action: Complete Story 2.12 (Docker multi-stage builds)
   - Timeline: Before Story 2.13 (Akash deployment)

### Can Deploy with Mitigation

4. **TECH-002: Pre-Existing Test Failures** (Score: 4)
   - Mitigation: Document failing tests, create tickets to fix
   - Monitoring: Track test failure rate, prioritize fixes
   - Acceptable if: Non-critical features affected

5. **OPS-003: Dev Scripts Not Validated** (Score: 4)
   - Mitigation: Document manual validation, add to onboarding
   - Acceptable if: Scripts work locally for dev team

6. **TECH-003: Workspace Dependency Resolution** (Score: 4)
   - Mitigation: Add smoke tests, monitor for import errors
   - Acceptable if: No runtime errors observed in testing

### Accepted Risks

7. **DATA-001: Git History Preservation** (Score: 4)
   - Acceptance: History documented, re-migration not justified
   - Sign-off: Dev Team Lead
   - Rationale: Cost of re-migration > benefit of full history

8. **PERF-001: Build Time Regression** (Score: 2)
   - Acceptance: Incremental builds are fast enough (<10s)
   - Monitoring: Benchmark build times quarterly

9. **OPS-004: Documentation Drift** (Score: 2)
   - Acceptance: Process improvements mitigate (PR checklist, reviews)
   - Monitoring: Quarterly doc audits

---

## Monitoring Requirements

### Post-Deployment Monitoring

**CI/CD Health:**
- CI pipeline success rate (target: >95%)
- Build time trends (alert if >2x baseline)
- Test flakiness rate (alert if >5%)
- Deployment failure rate (target: <5%)

**Build Health:**
- Package build success rate (target: 100%)
- Dependency vulnerability alerts (weekly scans)
- TypeScript compilation errors (zero tolerance)

**Development Experience:**
- Dev script startup time (target: <30s)
- `pnpm install` time (target: <2 minutes)
- Incremental build time (target: <10s)

**Test Health:**
- Test pass rate (target: 100%)
- Test execution time (target: <5 minutes)
- Coverage percentage (baseline: current level)

---

## Risk Review Triggers

**Update this risk profile when:**

1. **Architecture Changes:**
   - New packages added to workspace
   - Dependency graph significantly altered
   - Build system changes (e.g., move from pnpm to another tool)

2. **Deployment Changes:**
   - CI/CD pipeline implemented (OPS-001 resolved)
   - Docker configuration completed (OPS-002 resolved)
   - New deployment target added (e.g., Akash → AWS)

3. **Code Changes:**
   - lib-dassie-oer fixed (TECH-001 resolved)
   - Major refactoring across packages
   - New payment channels added (Story 2.11)

4. **Issues Discovered:**
   - Production incidents related to monorepo structure
   - Security vulnerabilities in dependencies
   - Performance regressions >20% from baseline

5. **Scheduled Reviews:**
   - Quarterly risk assessment (next: 2025-03-13)
   - End of Epic 2 (after Story 2.13)
   - Before any production release

---

## Recommendations for Gate Decision

Based on this risk profile, the following gate decision is recommended:

### Gate: **CONCERNS**

**Rationale:**
- **1 Critical Risk** (OPS-001: CI/CD) blocks production deployment
- **2 High Risks** (TECH-001, OPS-002) block full functionality
- **4 Medium Risks** need attention but don't block development
- Core monorepo migration is architecturally sound
- Development work can proceed with documented limitations

**Risk Summary for Gate File:**

```yaml
risk_summary:
  totals:
    critical: 1  # OPS-001: CI/CD
    high: 2      # TECH-001: lib-dassie-oer, OPS-002: Docker
    medium: 4    # TECH-002, OPS-003, TECH-003, DATA-001
    low: 2       # PERF-001, OPS-004
  highest:
    id: OPS-001
    score: 9
    title: 'CI/CD Pipeline Not Implemented'
  recommendations:
    must_fix:
      - 'Implement CI/CD pipeline (Task 10) before production deployment'
      - 'Fix lib-dassie-oer TypeScript errors (TECH-001)'
      - 'Complete Docker configuration in Story 2.12 (OPS-002)'
    monitor:
      - 'Track pre-existing test failures and create fix tickets (TECH-002)'
      - 'Validate dev scripts work correctly (OPS-003)'
      - 'Add smoke tests for workspace dependency resolution (TECH-003)'
```

---

## Appendix: Risk Calculation Details

### Overall Risk Score: 58/100

**Calculation:**
```
Base Score = 100
- Critical risks (1 × 20 points) = -20
- High risks (2 × 10 points) = -20
- Medium risks (4 × 5 points) = -20
- Low risks (2 × 2 points) = -4
────────────────────────────────
Final Score = 58/100
```

**Interpretation:**
- 90-100: Minimal Risk (ready for production)
- 70-89: Low Risk (acceptable with monitoring)
- 50-69: **Moderate Risk** ← **Story 2.10 is here**
- 30-49: High Risk (significant concerns)
- 0-29: Critical Risk (not ready for deployment)

**Conclusion:** Story 2.10 has **moderate risk** primarily due to deferred operational work (CI/CD, Docker). The core migration is solid, but production deployment must wait for Stories 2.12 and Task 10 completion.

---

**Risk Profile Generated by:** Quinn, Test Architect
**Model:** claude-sonnet-4-5-20250929[1m]
**Date:** 2025-12-13
**Next Review:** 2025-03-13 (quarterly) or when OPS-001/TECH-001/OPS-002 resolved
