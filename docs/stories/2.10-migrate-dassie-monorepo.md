# Story 2.10: Migrate Dassie into Monorepo

## Status

Draft

## Story

**As a** developer,
**I want** Dassie integrated into the nostream-ilp monorepo,
**so that** I can develop, build, and deploy both services together with shared types and tooling.

## Acceptance Criteria

1. Dassie source code moved into `packages/app-dassie/` directory
2. pnpm workspace configuration updated to include Dassie
3. Shared TypeScript types extracted to `packages/lib-payment-types/`
4. Smart contracts moved to `packages/lib-contracts/`
5. Build scripts work for both packages: `pnpm build` builds all
6. Dev scripts work: `pnpm dev:nostream` and `pnpm dev:dassie`
7. All existing Dassie tests pass in new location
8. Git history preserved (use `git subtree` or `git filter-branch`)
9. Documentation updated: README.md, architecture docs
10. CI/CD updated to build both packages

## Tasks / Subtasks

- [ ] Task 1: Prepare Monorepo Structure (AC: 1, 2)
  - [ ] Create `packages/` directory structure
  - [ ] Create root `package.json` with pnpm workspaces config:
    ```json
    {
      "name": "nostream-ilp-monorepo",
      "private": true,
      "workspaces": [
        "packages/*"
      ]
    }
    ```
  - [ ] Create `pnpm-workspace.yaml`:
    ```yaml
    packages:
      - 'packages/*'
    ```
  - [ ] Move existing nostream code to `packages/app-nostream/`
  - [ ] Update root `.gitignore` for monorepo patterns

- [ ] Task 2: Migrate Dassie Source Code (AC: 1, 8)
  - [ ] Copy Dassie repo from `/Users/jonathangreen/Documents/dassie` to `packages/app-dassie/`
  - [ ] Preserve git history using `git subtree` or copy approach
  - [ ] Copy Dassie's `packages/app-dassie/` to `packages/app-dassie/`
  - [ ] Copy Dassie's lib packages to `packages/lib-dassie-*/` (reactive, http-server, etc.)
  - [ ] Remove Dassie-specific files not needed (GUI packages, website)
  - [ ] Update `packages/app-dassie/package.json` dependencies for monorepo

- [ ] Task 3: Extract Shared Payment Types (AC: 3)
  - [ ] Create `packages/lib-payment-types/` package
  - [ ] Move payment-related TypeScript interfaces:
    - `PaymentClaim` interface
    - `PaymentChannelState` interface
    - Dassie RPC router types (tRPC AppRouter)
    - Currency enums (`BTC`, `BASE`, `AKT`, `XRP`)
  - [ ] Export types from `packages/lib-payment-types/src/index.ts`
  - [ ] Update `packages/app-nostream/` to import from `lib-payment-types`
  - [ ] Update `packages/app-dassie/` to import from `lib-payment-types`

- [ ] Task 4: Consolidate Smart Contracts (AC: 4)
  - [ ] Create `packages/lib-contracts/` package
  - [ ] Move existing contracts:
    - `MultiTokenPaymentChannelFactory.sol`
    - `BasePaymentChannel.sol`
    - `CronosPaymentChannel.sol`
  - [ ] Move Hardhat/Foundry config to `lib-contracts/`
  - [ ] Move contract tests to `lib-contracts/test/`
  - [ ] Move deployment scripts to `lib-contracts/scripts/`
  - [ ] Update contract package.json with build/test scripts
  - [ ] Generate TypeChain types in `lib-contracts/typechain-types/`

- [ ] Task 5: Update Build Configuration (AC: 5)
  - [ ] Create root `package.json` scripts:
    ```json
    {
      "scripts": {
        "build": "pnpm -r build",
        "build:nostream": "pnpm --filter app-nostream build",
        "build:dassie": "pnpm --filter app-dassie build",
        "build:contracts": "pnpm --filter lib-contracts build",
        "test": "pnpm -r test",
        "lint": "pnpm -r lint"
      }
    }
    ```
  - [ ] Update each package's `package.json` with proper `name` field:
    - `@nostream-ilp/app-nostream`
    - `@nostream-ilp/app-dassie`
    - `@nostream-ilp/lib-payment-types`
    - `@nostream-ilp/lib-contracts`
  - [ ] Configure TypeScript project references in root `tsconfig.json`
  - [ ] Test build: `pnpm build` succeeds for all packages

- [ ] Task 6: Update Development Scripts (AC: 6)
  - [ ] Add root dev scripts:
    ```json
    {
      "scripts": {
        "dev:nostream": "pnpm --filter app-nostream dev",
        "dev:dassie": "pnpm --filter app-dassie dev",
        "dev:all": "concurrently \"pnpm dev:nostream\" \"pnpm dev:dassie\""
      }
    }
    ```
  - [ ] Install `concurrently` for parallel dev servers
  - [ ] Update `packages/app-nostream/package.json` dev script
  - [ ] Update `packages/app-dassie/package.json` dev script
  - [ ] Test: `pnpm dev:nostream` starts relay
  - [ ] Test: `pnpm dev:dassie` starts Dassie node
  - [ ] Test: `pnpm dev:all` starts both

- [ ] Task 7: Migrate and Verify Tests (AC: 7)
  - [ ] Run Dassie tests in new location: `pnpm --filter app-dassie test`
  - [ ] Run Nostream tests: `pnpm --filter app-nostream test`
  - [ ] Run contract tests: `pnpm --filter lib-contracts test`
  - [ ] Fix any broken import paths
  - [ ] Verify all tests pass: `pnpm test`
  - [ ] Update test scripts in root package.json

- [ ] Task 8: Update Documentation (AC: 9)
  - [ ] Update `README.md`:
    - Monorepo structure explanation
    - Package overview (app-nostream, app-dassie, lib-*)
    - Build instructions for monorepo
    - Development workflow
  - [ ] Create `packages/app-dassie/README.md` (Dassie-specific docs)
  - [ ] Update `docs/architecture/source-tree-structure.md` with new layout
  - [ ] Add `MONOREPO.md` guide:
    - How to add new packages
    - Dependency management with pnpm workspaces
    - Cross-package imports
    - Testing strategy

- [ ] Task 9: Update Docker Configuration (AC: 10, prep for Story 2.12)
  - [ ] Create `docker/Dockerfile.nostream` (multi-stage build from packages/)
  - [ ] Create `docker/Dockerfile.dassie` (multi-stage build from packages/)
  - [ ] Update `docker-compose.yml` to use new Dockerfiles
  - [ ] Update build context paths in docker-compose
  - [ ] Test: `docker-compose build` succeeds
  - [ ] Test: `docker-compose up` starts both services
  - [ ] Verify services can communicate (Nostream → Dassie RPC)

- [ ] Task 10: Update CI/CD (AC: 10)
  - [ ] Update `.github/workflows/*.yml` (if exists):
    - Install pnpm
    - Build all packages: `pnpm build`
    - Run all tests: `pnpm test`
    - Lint all packages: `pnpm lint`
  - [ ] Add matrix build for each package (optional optimization)
  - [ ] Update build caching strategy for pnpm
  - [ ] Test CI passes on pull request

- [ ] Task 11: Clean Up and Validate (AC: all)
  - [ ] Remove original Dassie repo reference from docs
  - [ ] Update environment variable documentation (now single .env file)
  - [ ] Verify dependency deduplication: `pnpm list` shows no duplicates
  - [ ] Check bundle sizes haven't increased significantly
  - [ ] Run full regression: `pnpm build && pnpm test && pnpm lint`
  - [ ] Verify Docker images build: `docker-compose build`
  - [ ] Tag migration commit with clear message

## Dev Notes

### Architecture Context

**Monorepo Benefits:**

This migration transforms the project from two separate repos into a unified monorepo using **pnpm workspaces**. This architecture enables:

1. **Atomic Changes**: Modify Nostream + Dassie in single commit
2. **Type Safety**: Shared TypeScript types via workspace dependencies
3. **Simplified Deployment**: Single Docker build context for both services
4. **Better DX**: One `pnpm install`, one `pnpm build`, one repo to clone

**Current Structure (Before):**
```
/Users/jonathangreen/Documents/
├── nostream-ilp/           # Relay + BTP-NIPs
│   ├── src/
│   ├── contracts/          # Smart contracts
│   └── docker/
└── dassie/                 # Separate repo
    └── packages/
        └── app-dassie/
```

**Target Structure (After):**
```
nostream-ilp/               # Monorepo root
├── packages/
│   ├── app-nostream/       # Nostr relay + BTP-NIPs
│   ├── app-dassie/         # Dassie ILP node
│   ├── lib-payment-types/  # Shared TypeScript types
│   ├── lib-contracts/      # Smart contracts + scripts
│   ├── lib-dassie-reactive/# Dassie reactive library
│   └── lib-dassie-*/       # Other Dassie libs
├── docker/
│   ├── Dockerfile.nostream
│   └── Dockerfile.dassie
├── pnpm-workspace.yaml
└── package.json            # Root workspace config
```

[Source: Story 8.3 analysis, Epic 2 PRD]

---

### Monorepo Migration Strategy

**Step 1: Prepare Structure**
- Create `packages/` directory
- Configure pnpm workspaces
- Move existing code to `packages/app-nostream/`

**Step 2: Copy Dassie**
- Copy from `/Users/jonathangreen/Documents/dassie`
- Preserve relevant packages (app-dassie, lib-*)
- Remove GUI/website packages (not needed for relay)

**Step 3: Extract Shared Code**
- `lib-payment-types`: PaymentClaim, ChannelState, tRPC types
- `lib-contracts`: All Solidity contracts + TypeChain output

**Step 4: Wire Dependencies**
- Update package.json files with workspace dependencies
- Example: `app-nostream` depends on `lib-payment-types`
- Use workspace protocol: `"@nostream-ilp/lib-payment-types": "workspace:*"`

[Source: pnpm workspaces documentation]

---

### Package Naming Convention

All packages use scoped naming:

| Package | Name | Purpose |
|---------|------|---------|
| Nostream | `@nostream-ilp/app-nostream` | Main relay application |
| Dassie | `@nostream-ilp/app-dassie` | ILP node |
| Payment Types | `@nostream-ilp/lib-payment-types` | Shared interfaces |
| Contracts | `@nostream-ilp/lib-contracts` | Smart contracts |
| Dassie Reactive | `@nostream-ilp/lib-dassie-reactive` | Reactive primitives |

[Source: pnpm workspace best practices]

---

### TypeScript Project References

Enable faster builds with TypeScript project references:

**Root `tsconfig.json`:**
```json
{
  "references": [
    { "path": "./packages/app-nostream" },
    { "path": "./packages/app-dassie" },
    { "path": "./packages/lib-payment-types" }
  ]
}
```

**Package `tsconfig.json` (example: app-nostream):**
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "composite": true,
    "outDir": "./dist"
  },
  "references": [
    { "path": "../lib-payment-types" }
  ]
}
```

This enables:
- Incremental builds (only rebuild changed packages)
- Type checking across package boundaries
- Better IDE performance

[Source: TypeScript Handbook - Project References]

---

### Docker Multi-Stage Builds

Both Dockerfiles will use multi-stage builds from monorepo:

**Dockerfile.nostream:**
```dockerfile
# Stage 1: Build all dependencies
FROM node:22-alpine AS builder
WORKDIR /app
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/app-nostream/package.json ./packages/app-nostream/
COPY packages/lib-payment-types/package.json ./packages/lib-payment-types/
RUN corepack enable && pnpm install --frozen-lockfile

# Stage 2: Build
COPY packages/ ./packages/
RUN pnpm --filter app-nostream build

# Stage 3: Production
FROM node:22-alpine
COPY --from=builder /app/packages/app-nostream/dist /app
CMD ["node", "/app/index.js"]
```

[Source: Story 8.1 Docker containerization]

---

### Testing Strategy

**Unit Tests:**
- Each package maintains its own tests
- Run per-package: `pnpm --filter app-nostream test`
- Run all: `pnpm test`

**Integration Tests:**
- New `packages/integration-tests/` package
- Tests communication between Nostream ↔ Dassie
- Uses Testcontainers for real Docker services

**Contract Tests:**
- Remain in `lib-contracts/test/`
- Use Hardhat or Foundry
- Test MultiTokenPaymentChannelFactory

[Source: docs/architecture/testing-strategy.md]

---

### Migration Risks and Mitigations

**Risk 1: Breaking Existing Builds**
- Mitigation: Complete migration in feature branch
- Verify all tests pass before merging
- Keep old Dassie repo as backup until stable

**Risk 2: Import Path Changes**
- Mitigation: Use TypeScript path aliases
- Update all imports systematically
- Use IDE refactoring tools

**Risk 3: Docker Build Complexity**
- Mitigation: Test Docker builds frequently
- Use build cache effectively
- Document build process thoroughly

**Risk 4: Git History Loss**
- Mitigation: Use `git subtree` to preserve Dassie history
- Document commit where Dassie was merged
- Keep reference to original Dassie commit SHA

[Source: Monorepo migration best practices]

---

### Data Models

No new data models in this story - this is purely a code reorganization.

Existing data models remain:
- `NostrEvent` (PostgreSQL) - unchanged
- `PaymentClaim` (PostgreSQL) - unchanged
- Dassie internal ledger (SQLite) - unchanged

[Source: docs/architecture/data-models.md]

---

### Dependencies

**Story Dependencies:**
- ✅ Epic 1 complete (Nostream forked and running)
- ✅ Story 8.1 complete (Docker containers work)
- ⏳ Dassie repo accessible at `/Users/jonathangreen/Documents/dassie`

**Blocking Stories:**
- None - this is a foundational refactor

**Blocked Stories:**
- Story 2.11: Integrate MultiTokenPaymentChannelFactory (needs monorepo)
- Story 2.12: Create Docker Images (needs monorepo structure)
- Story 2.13: Update Akash Deployment (needs Docker images)

[Source: Epic 2 PRD]

---

### File Locations

**Files to Create:**
- `pnpm-workspace.yaml` - Workspace configuration
- `packages/app-nostream/` - Moved from `src/`
- `packages/app-dassie/` - Copied from Dassie repo
- `packages/lib-payment-types/` - New shared types package
- `packages/lib-contracts/` - Moved from `contracts/`
- `docker/Dockerfile.nostream` - Updated for monorepo
- `docker/Dockerfile.dassie` - New
- `MONOREPO.md` - Developer guide

**Files to Modify:**
- Root `package.json` - Add workspace config
- `README.md` - Document monorepo structure
- `docs/architecture/source-tree-structure.md` - Update layout
- `.gitignore` - Add monorepo patterns

**Files to Remove:**
- Old references to separate Dassie repo in docs

[Source: docs/architecture/source-tree-structure.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-11 | 1.0 | Initial story creation for monorepo migration | Sarah (PO) |

---

## Testing

### Pre-Migration Validation

```bash
# Verify current state works
cd /Users/jonathangreen/Documents/nostream-ilp
npm test

cd /Users/jonathangreen/Documents/dassie
pnpm test
```

### Post-Migration Validation

```bash
# Install dependencies
pnpm install

# Build all packages
pnpm build

# Run all tests
pnpm test

# Verify Docker builds
docker-compose build

# Start services
docker-compose up -d

# Test Nostream → Dassie communication
curl http://localhost:8008/health  # Nostream
curl http://localhost:7768/health  # Dassie (if exposed)
```

**Success Criteria:**
- ✅ All packages build without errors
- ✅ All tests pass (Nostream + Dassie + Contracts)
- ✅ Docker images build successfully
- ✅ Services start and communicate
- ✅ No duplicate dependencies in pnpm-lock.yaml
- ✅ Build time not significantly slower than before

---

## QA Results

_To be filled by QA Agent_
