# Story 2.13: Update Akash Deployment with Dassie Service

## Status

Draft

## Story

**As a** peer operator,
**I want** both Nostream and Dassie deployed together on Akash,
**so that** my peer node has full payment verification capabilities.

## Acceptance Criteria

1. Update `akash/deploy.yaml` to include Dassie service
2. Configure resource allocation for Dassie (0.35 CPU, 512Mi RAM, 5Gi storage)
3. Update pricing to include Dassie (add 200 uAKT/block)
4. Configure service dependencies (nostream depends on dassie)
5. Configure internal networking (nostream → dassie:7768)
6. Update environment variables for both services
7. Total cost remains <$10/month (1,150 uAKT/block total)
8. Test deployment to Akash sandbox/testnet
9. Verify services can communicate
10. Update deployment documentation

## Tasks / Subtasks

- [ ] Task 1: Add Dassie Service to SDL (AC: 1, 2)
  - [ ] Update `akash/deploy.yaml` to add Dassie service:
    ```yaml
    services:
      nostream:
        image: nostream-ilp:v1.0.0-mainnet
        # ... existing config ...
        depends_on:
          - postgres
          - redis
          - dassie  # NEW

      dassie:  # NEW SERVICE
        image: dassie-node:v1.0.0-mainnet
        expose:
          - port: 7768
            to:
              - service: nostream
        env:
          - NODE_ENV=production
          - RPC_AUTH_TOKEN=${DASSIE_RPC_TOKEN}
          - LEDGER_DB_PATH=/app/data/ledger.db
          - SETTLEMENT_BASE_ENABLED=${SETTLEMENT_BASE_ENABLED}
          - SETTLEMENT_BASE_RPC_URL=${SETTLEMENT_BASE_RPC_URL}
          - SETTLEMENT_BASE_FACTORY_ADDRESS=${SETTLEMENT_BASE_FACTORY_ADDRESS}
          - SETTLEMENT_BASE_RELAY_PRIVATE_KEY=${SETTLEMENT_BASE_RELAY_PRIVATE_KEY}
          - SETTLEMENT_CRONOS_ENABLED=${SETTLEMENT_CRONOS_ENABLED}
          - SETTLEMENT_CRONOS_RPC_URL=${SETTLEMENT_CRONOS_RPC_URL}
          - SETTLEMENT_CRONOS_FACTORY_ADDRESS=${SETTLEMENT_CRONOS_FACTORY_ADDRESS}
          - SETTLEMENT_CRONOS_RELAY_PRIVATE_KEY=${SETTLEMENT_CRONOS_RELAY_PRIVATE_KEY}

      postgres:
        # ... existing ...

      redis:
        # ... existing ...
    ```
  - [ ] Port 7768 exposed only to nostream service (not global)
  - [ ] Validate SDL syntax

- [ ] Task 2: Configure Dassie Resources (AC: 2)
  - [ ] Add Dassie compute profile:
    ```yaml
    profiles:
      compute:
        nostream:
          resources:
            cpu:
              units: 0.5
            memory:
              size: 1Gi
            storage:
              size: 10Gi

        dassie:  # NEW
          resources:
            cpu:
              units: 0.35
            memory:
              size: 512Mi
            storage:
              size: 5Gi

        postgres:
          resources:
            cpu:
              units: 0.25
            memory:
              size: 512Mi
            storage:
              size: 20Gi

        redis:
          resources:
            cpu:
              units: 0.1
            memory:
              size: 256Mi
            storage:
              size: 1Gi
    ```
  - [ ] Total resources: 1.2 CPU, 2.25Gi RAM, 36Gi storage
  - [ ] Validate reasonable for ILP node workload

- [ ] Task 3: Update Pricing (AC: 3, 7)
  - [ ] Update placement pricing:
    ```yaml
    profiles:
      placement:
        dcloud:
          pricing:
            nostream:
              denom: uakt
              amount: 550  # unchanged

            dassie:  # NEW
              denom: uakt
              amount: 200  # $2/month for Dassie

            postgres:
              denom: uakt
              amount: 300  # unchanged

            redis:
              denom: uakt
              amount: 100  # unchanged
    ```
  - [ ] Total: 1,150 uAKT/block
  - [ ] Calculate monthly cost:
    - Blocks/month: ~1,051,200 (30 days)
    - AKT/month: (1,150 × 1,051,200) / 1,000,000 = 1.209 AKT
    - USD/month: 1.209 × $5/AKT = $6.04/month
  - [ ] Verify <$10/month ✓

- [ ] Task 4: Add Dassie Deployment Profile (AC: 1)
  - [ ] Add to deployment section:
    ```yaml
    deployment:
      nostream:
        dcloud:
          profile: nostream
          count: 1

      dassie:  # NEW
        dcloud:
          profile: dassie
          count: 1

      postgres:
        dcloud:
          profile: postgres
          count: 1

      redis:
        dcloud:
          profile: redis
          count: 1
    ```
  - [ ] All services count=1 (single instance)

- [ ] Task 5: Update Nostream Environment Variables (AC: 4, 5, 6)
  - [ ] Update Nostream service env to connect to Dassie:
    ```yaml
    nostream:
      env:
        # ... existing vars ...
        - BTP_NIPS_ENABLED=true
        - DASSIE_RPC_URL=ws://dassie:7768/trpc  # Service discovery
        - DASSIE_RPC_TOKEN=${DASSIE_RPC_TOKEN}
    ```
  - [ ] Use service name `dassie` (not localhost)
  - [ ] Port 7768 (Dassie's RPC port)

- [ ] Task 6: Update akash/.env.mainnet (AC: 6)
  - [ ] Add Dassie-specific variables to `.env.mainnet`:
    ```bash
    # ===========================================
    # Dassie RPC Configuration
    # ===========================================
    DASSIE_RPC_TOKEN=your-rpc-token-here-min-32-chars

    # ===========================================
    # Settlement Modules (Optional)
    # ===========================================

    # Base L2 Settlement
    SETTLEMENT_BASE_ENABLED=false
    SETTLEMENT_BASE_RPC_URL=https://mainnet.base.org
    SETTLEMENT_BASE_FACTORY_ADDRESS=0x...
    SETTLEMENT_BASE_RELAY_PRIVATE_KEY=0x...

    # Cronos Settlement
    SETTLEMENT_CRONOS_ENABLED=true
    SETTLEMENT_CRONOS_RPC_URL=https://evm.cronos.org
    SETTLEMENT_CRONOS_FACTORY_ADDRESS=0x9Ec2d217b14e67cAbF86F20F4E7462D6d7bc7684
    SETTLEMENT_CRONOS_RELAY_PRIVATE_KEY=0x...
    ```
  - [ ] Generate DASSIE_RPC_TOKEN: `openssl rand -hex 32`
  - [ ] Document required vs optional variables

- [ ] Task 7: Update Deployment Scripts (AC: 8)
  - [ ] Update `scripts/akash-deploy.ts` (if using SDK):
    - Load Dassie env vars
    - Include in deployment manifest
  - [ ] Or update CLI deployment command in documentation:
    ```bash
    akash tx deployment create akash/deploy.yaml \
      --from mainnet-wallet \
      --node https://rpc.akashnet.net:443 \
      --chain-id akashnet-2 \
      --env-file akash/.env.mainnet \
      --gas auto \
      --gas-prices 0.025uakt \
      --yes
    ```
  - [ ] Env file now includes Dassie vars

- [ ] Task 8: Test Sandbox Deployment (AC: 8)
  - [ ] Deploy to Akash sandbox:
    ```bash
    npm run akash:deploy:sandbox
    ```
  - [ ] Monitor deployment creation
  - [ ] Wait for provider bid acceptance
  - [ ] Check service logs:
    ```bash
    npm run akash:logs -- <DSEQ>
    ```
  - [ ] Verify all 4 services start (nostream, dassie, postgres, redis)
  - [ ] Check for connection errors

- [ ] Task 9: Verify Service Communication (AC: 9)
  - [ ] Get provider URI from lease
  - [ ] Access Nostream: `curl https://<provider-uri>:443`
  - [ ] Check Nostream logs for "Connected to Dassie RPC"
  - [ ] Send test Nostr event with payment claim
  - [ ] Verify Dassie verifies payment (check Dassie logs)
  - [ ] Confirm no RPC connection errors

- [ ] Task 10: Update Documentation (AC: 10)
  - [ ] Update `akash/README.md`:
    - Dassie service explanation
    - Resource allocation rationale
    - Environment variable requirements
    - Cost breakdown (now $6/month)
  - [ ] Update `docs/deployment-runbook.md`:
    - Add Dassie service section
    - Update cost estimates
    - Add Dassie health check instructions
  - [ ] Update deployment snapshot template:
    ```json
    {
      "services": {
        "nostream": "nostream-ilp:v1.0.0-mainnet",
        "dassie": "dassie-node:v1.0.0-mainnet",  // NEW
        "postgres": "postgres:16-alpine",
        "redis": "redis:7-alpine"
      },
      "cost": {
        "uakt_per_block": 1150,  // Updated
        "akt_per_month": 1.209,  // Updated
        "usd_per_month": 6.04    // Updated
      }
    }
    ```

- [ ] Task 11: Update Story 8.3 References (AC: 10)
  - [ ] Update `docs/stories/8.3.story.md` Dev Notes:
    - Remove "Dassie not implemented" warnings
    - Update expected cost to $6/month
    - Reference Epic 2 completion
  - [ ] Update Story 8.3 Tasks (if not already deployed):
    - Task 4: Note Dassie service now included
    - Task 12: Update cost verification to 1,150 uAKT/block

- [ ] Task 12: Create Deployment Validation Checklist (AC: 9)
  - [ ] Create `docs/checklists/dassie-deployment-checklist.md`:
    ```markdown
    # Dassie Deployment Validation Checklist

    ## Pre-Deployment
    - [ ] DASSIE_RPC_TOKEN generated (32+ chars)
    - [ ] Settlement module configured (if using)
    - [ ] Relay private keys secured
    - [ ] Docker images built and tagged

    ## Deployment
    - [ ] SDL includes all 4 services
    - [ ] Total pricing = 1,150 uAKT/block
    - [ ] Dassie depends_on nostream ✓
    - [ ] Environment variables injected

    ## Post-Deployment
    - [ ] All containers running (docker ps or Akash query)
    - [ ] Nostream health check passes
    - [ ] Dassie health check passes (if exposed)
    - [ ] Nostream logs show "Connected to Dassie RPC"
    - [ ] No RPC authentication errors
    - [ ] Payment verification works (test claim)

    ## Cost Verification
    - [ ] Lease pricing ≤ 1,150 uAKT/block
    - [ ] Estimated monthly: $6-7 USD
    ```
  - [ ] Use checklist during deployments

## Dev Notes

### Architecture Context

**Complete Peer Node Architecture:**

With Dassie added, the Akash deployment becomes a full peer node with ILP payment capabilities:

```
┌─────────────────────────────────────────┐
│         Akash Provider                  │
│                                         │
│  ┌──────────────┐    ┌──────────────┐  │
│  │   Nostream   │───▶│    Dassie    │  │
│  │   (Relay)    │    │  (ILP Node)  │  │
│  │   :443,:8080 │    │    :7768     │  │
│  └──────────────┘    └──────────────┘  │
│         │ │                  │          │
│         │ └────────┬─────────┘          │
│         │          │                    │
│  ┌──────▼────┐  ┌──▼──────┐            │
│  │ PostgreSQL│  │  Redis  │            │
│  │   :5432   │  │  :6379  │            │
│  └───────────┘  └─────────┘            │
│                                         │
│  Exposed Ports (Global):                │
│  - 443: HTTPS/WSS (Nostr clients)      │
│  - 8080: Dashboard                      │
└─────────────────────────────────────────┘
```

**Service Communication:**
- Nostream → Dassie: WebSocket RPC (ws://dassie:7768/trpc)
- Nostream → PostgreSQL: TCP (postgresql://postgres:5432)
- Nostream → Redis: TCP (redis://redis:6379)
- Dassie: Internal only (no global ports)

[Source: Story 2.12 Docker images, Epic 8 deployment]

---

### Resource Allocation Rationale

**Dassie Resources (0.35 CPU, 512Mi RAM, 5Gi storage):**

- **CPU (0.35 units)**:
  - ILP packet routing is CPU-light
  - Payment verification is cryptographic (moderate CPU)
  - Lower than Nostream (0.5) since fewer concurrent connections

- **RAM (512Mi)**:
  - Dassie internal ledger (SQLite) in-memory caching
  - tRPC server overhead
  - Settlement module state
  - Equal to PostgreSQL, less than Nostream

- **Storage (5Gi)**:
  - Dassie ledger database (SQLite)
  - Grows with transaction volume
  - Much smaller than PostgreSQL (20Gi for events)

**Total Resources:**
- CPU: 1.2 units (was 0.85, +41% increase)
- RAM: 2.25Gi (was 1.75Gi, +29% increase)
- Storage: 36Gi (was 31Gi, +16% increase)

**Cost Impact:**
- Additional: 200 uAKT/block for Dassie
- New total: 1,150 uAKT/block
- Monthly: $6.04 (was $4.99, +$1.05)

[Source: Dassie resource requirements, Story 8.2 pricing]

---

### Akash SDL Service Dependencies

**Why nostream depends_on dassie?**

```yaml
nostream:
  depends_on:
    - postgres
    - redis
    - dassie  # NEW
```

**Startup Order:**
1. PostgreSQL starts (no dependencies)
2. Redis starts (no dependencies)
3. **Dassie starts** (no dependencies)
4. Nostream starts (waits for postgres, redis, **dassie**)

**Without depends_on:**
- Nostream might start before Dassie
- RPC connection fails on startup
- Nostream enters degraded mode (no payment verification)

**With depends_on:**
- Akash ensures Dassie starts first
- Nostream connects successfully on first try
- Payment verification works immediately

[Source: Akash SDL documentation, docker-compose depends_on]

---

### Internal vs Global Port Exposure

**Global Ports (public internet):**
```yaml
nostream:
  expose:
    - port: 443
      as: 443
      to:
        - global: true  # Publicly accessible
```

**Internal Ports (service-to-service only):**
```yaml
dassie:
  expose:
    - port: 7768
      to:
        - service: nostream  # Only Nostream can access
```

**Security:**
- Dassie RPC is NOT exposed to internet
- Only Nostream can connect (via internal Docker network)
- RPC token authentication still required
- PostgreSQL and Redis also internal-only

[Source: Akash SDL port exposure, security best practices]

---

### Cost Breakdown (Updated)

**Previous Cost (Epic 8.2):**
- Nostream: 550 uAKT/block
- PostgreSQL: 300 uAKT/block
- Redis: 100 uAKT/block
- **Total**: 950 uAKT/block = $4.99/month

**New Cost (with Dassie):**
- Nostream: 550 uAKT/block
- **Dassie**: 200 uAKT/block ← NEW
- PostgreSQL: 300 uAKT/block
- Redis: 100 uAKT/block
- **Total**: 1,150 uAKT/block = **$6.04/month**

**Calculation:**
```
Blocks per month = 30 days × 24h × 60m × 60s / 6s = 1,051,200
AKT per month = (1,150 × 1,051,200) / 1,000,000 = 1.209 AKT
USD per month = 1.209 AKT × $5/AKT = $6.04
```

**Still under $10/month target** ✓

[Source: Story 8.2 cost analysis, Akash pricing]

---

### Environment Variable Security

**Sensitive Variables:**
- `DASSIE_RPC_TOKEN`: RPC authentication (32+ chars)
- `SETTLEMENT_*_RELAY_PRIVATE_KEY`: Private keys for signing transactions

**Security Best Practices:**
1. **Never commit** `.env.mainnet` to git (use `.gitignore`)
2. **Generate random tokens**: `openssl rand -hex 32`
3. **Rotate secrets**: Change RPC token quarterly
4. **Use separate keys**: Different private keys for each network
5. **Backup securely**: Encrypted backup of private keys

**Akash Injection:**
- Use `--env-file akash/.env.mainnet` (CLI method)
- Or SDK: Load from `.env.mainnet` and inject programmatically
- Akash encrypts env vars in transit and at rest

[Source: docs/architecture/security-architecture.md]

---

### Deployment Validation

**How to verify Dassie is working:**

1. **Check container is running:**
   ```bash
   akash provider service-status \
     --dseq <DSEQ> \
     --provider <PROVIDER> \
     --node https://rpc.akashnet.net:443
   ```
   Expected: `dassie: { available: 1, ready: 1 }`

2. **Check Nostream logs:**
   ```bash
   akash provider service-logs \
     --dseq <DSEQ> \
     --provider <PROVIDER> \
     --service nostream
   ```
   Look for: "Connected to Dassie RPC" or "tRPC client initialized"

3. **Test payment verification:**
   - Send Nostr event with payment claim tag
   - Check Dassie logs for verification attempt
   - Verify no authentication errors

[Source: docs/deployment-runbook.md health checks]

---

### Testing Strategy

**Sandbox/Testnet Testing:**

Before mainnet, test on Akash sandbox:

```bash
# Update deploy.yaml for sandbox
sed -i 's/:v1.0.0-mainnet/:latest/g' akash/deploy.yaml

# Deploy to sandbox
npm run akash:deploy:sandbox

# Monitor
npm run akash:logs -- <DSEQ>

# Verify all services start
# Check for RPC connection success
```

**Mainnet Deployment:**
- Use versioned images (`:v1.0.0-mainnet`)
- Double-check `.env.mainnet` has all variables
- Verify wallet has ≥6 AKT (higher deposit due to more services)
- Follow deployment runbook

[Source: Story 8.2 sandbox testing, Story 8.3 mainnet deployment]

---

### Data Models

No new data models - Dassie uses its own SQLite internal ledger.

**Dassie Ledger Schema:**
```sql
-- Internal double-entry ledger
CREATE TABLE accounts (
  id TEXT PRIMARY KEY,
  balance INTEGER NOT NULL
);

CREATE TABLE transactions (
  id INTEGER PRIMARY KEY,
  debit_account TEXT,
  credit_account TEXT,
  amount INTEGER,
  timestamp INTEGER
);
```

Nostream data models unchanged:
- `NostrEvent` (PostgreSQL)
- `PaymentClaim` (PostgreSQL)

[Source: Dassie internal ledger documentation]

---

### Dependencies

**Story Dependencies:**
- ✅ Story 2.10 complete (Monorepo)
- ✅ Story 2.11 complete (MultiTokenPaymentChannelFactory integration)
- ✅ Story 2.12 complete (Docker images)

**Blocking Stories:**
- None - this completes Epic 2 deployment integration

**Blocked Stories:**
- Story 8.3 (mainnet deployment) - can now proceed with full Dassie support

[Source: Epic 2 PRD]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-11 | 1.0 | Initial story creation for Akash deployment with Dassie | Sarah (PO) |

---

## Testing

```bash
# Validate SDL syntax
cat akash/deploy.yaml | grep -A 50 "dassie:"

# Deploy to sandbox
npm run akash:deploy:sandbox

# Check deployment status
npm run akash:list

# Get logs
npm run akash:logs -- <DSEQ>

# Verify services
curl https://<provider-uri>:443  # Nostream
# Check Nostream logs for Dassie connection

# Close sandbox deployment
npm run akash:close -- <DSEQ>
```

**Success Criteria:**
- ✅ SDL validates (no syntax errors)
- ✅ All 4 services deploy successfully
- ✅ Nostream connects to Dassie RPC
- ✅ No authentication errors in logs
- ✅ Payment verification works
- ✅ Cost ≤ 1,150 uAKT/block (~$6/month)

---

## QA Results

_To be filled by QA Agent_
