# Story 11.7: Docker Network Simulation Infrastructure

**Epic:** 11 - BTP-NIPs N-Peer Network Verification
**Status:** Draft
**Priority:** Medium
**Estimated Effort:** 2 days
**Created:** 2025-12-16
**Dependencies:** Story 11.4 (Docker Dassie Integration)

---

## Story

**As a** QA Engineer,
**I want** Docker network simulation with configurable latency, jitter, and packet loss using `tc` (traffic control),
**so that** I can test BTP-NIPs and ILP behavior under realistic network conditions.

---

## Acceptance Criteria

### AC 1: Docker Network with Traffic Control

**Given** Docker Compose stack from Story 11.4
**When** containers start with network simulation enabled
**Then** the system should:
- ✅ Create custom Docker network with `tc` (traffic control) support
- ✅ Apply network conditions per container (latency, jitter, packet loss)
- ✅ Support independent configuration for each node
- ✅ Network conditions apply to all traffic from container
- ✅ Conditions remain stable throughout test execution

**Docker Compose Network Configuration:**
```yaml
networks:
  n-peer-test:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-dassie-test
    ipam:
      config:
        - subnet: 172.20.0.0/24
```

### AC 2: Latency Simulation

**Given** Docker container with latency configuration
**When** traffic flows from the container
**Then** the system should:
- ✅ Add configurable latency (e.g., 50ms, 100ms, 200ms)
- ✅ Support asymmetric latency (different values per direction)
- ✅ Apply latency consistently across all protocols (TCP, UDP, ICMP)
- ✅ Measure actual latency matches configured value (±10%)
- ✅ Latency configuration via environment variable

**Latency Configuration:**
```yaml
dassie-node-0:
  environment:
    NETWORK_LATENCY: "50ms"
    NETWORK_JITTER: "10ms"
```

### AC 3: Packet Loss Simulation

**Given** Docker container with packet loss configuration
**When** traffic flows from the container
**Then** the system should:
- ✅ Drop packets at configurable rate (e.g., 1%, 5%, 10%)
- ✅ Apply random packet loss distribution
- ✅ Support asymmetric packet loss (different values per direction)
- ✅ Measure actual packet loss matches configured value (±2%)
- ✅ Packet loss configuration via environment variable

**Packet Loss Configuration:**
```yaml
dassie-node-1:
  environment:
    NETWORK_PACKET_LOSS: "5%"
```

### AC 4: Jitter Simulation

**Given** Docker container with jitter configuration
**When** traffic flows from the container
**Then** the system should:
- ✅ Add configurable jitter (variation in latency, e.g., ±10ms)
- ✅ Use normal distribution for jitter variation
- ✅ Apply jitter on top of base latency
- ✅ Measure actual jitter standard deviation (±3ms)
- ✅ Jitter configuration via environment variable

**Jitter Configuration:**
```yaml
dassie-node-2:
  environment:
    NETWORK_LATENCY: "100ms"
    NETWORK_JITTER: "20ms"
```

### AC 5: Initialization Script for Traffic Control

**Given** Docker container starts with network simulation config
**When** container initializes
**Then** the system should:
- ✅ Run `tc` initialization script in container entrypoint
- ✅ Apply `tc qdisc` rules based on environment variables
- ✅ Verify `tc` rules applied successfully
- ✅ Log network simulation parameters on startup
- ✅ Fail container startup if `tc` configuration fails

**Initialization Script (`scripts/apply-network-sim.sh`):**
```bash
#!/bin/bash
set -e

# Read configuration from environment
LATENCY=${NETWORK_LATENCY:-0ms}
JITTER=${NETWORK_JITTER:-0ms}
PACKET_LOSS=${NETWORK_PACKET_LOSS:-0%}

# Apply tc rules if any simulation enabled
if [ "$LATENCY" != "0ms" ] || [ "$PACKET_LOSS" != "0%" ]; then
  echo "Applying network simulation: latency=$LATENCY jitter=$JITTER loss=$PACKET_LOSS"

  tc qdisc add dev eth0 root netem \
    delay $LATENCY $JITTER \
    loss $PACKET_LOSS

  echo "✓ Network simulation applied"
else
  echo "Network simulation disabled"
fi
```

### AC 6: Test Framework Integration

**Given** test framework from Story 11.1
**When** creating test network with simulation config
**Then** the system should:
- ✅ Accept `networkSimulation` parameter in `createTestNetwork()`
- ✅ Pass simulation config to Docker Compose via environment
- ✅ Verify network conditions applied before running tests
- ✅ Include network metrics in test output
- ✅ Support disabling simulation for baseline tests

**Test Framework Usage:**
```typescript
const nodes = await createTestNetwork(5, {
  executionMode: 'docker',
  dockerCompose: './test/docker/dassie-stack.yml',
  dassieNodes: true,
  networkSimulation: {
    latency: 50,      // 50ms base latency
    jitter: 10,       // ±10ms jitter
    packetLoss: 0.02  // 2% packet loss
  }
});
```

### AC 7: Network Condition Verification

**Given** network simulation applied to containers
**When** running verification checks
**Then** the system should:
- ✅ Ping test between nodes measures expected latency
- ✅ Packet loss rate measured over 100 pings (±2%)
- ✅ Jitter measured via ping standard deviation (±3ms)
- ✅ Verification passes before test execution begins
- ✅ Verification failures logged with diagnostic info

**Verification Function:**
```typescript
async function verifyNetworkConditions(
  nodes: TestNode[],
  expectedLatency: number,
  expectedPacketLoss: number
): Promise<boolean> {
  // Ping test between nodes[0] and nodes[1]
  const pingResults = await runPingTest(nodes[0], nodes[1], 100);

  const actualLatency = pingResults.averageLatency;
  const actualPacketLoss = pingResults.packetLoss;

  const latencyMatch = Math.abs(actualLatency - expectedLatency) <= expectedLatency * 0.1;
  const packetLossMatch = Math.abs(actualPacketLoss - expectedPacketLoss) <= 0.02;

  return latencyMatch && packetLossMatch;
}
```

### AC 8: Performance Impact Testing

**Given** test suite running with and without simulation
**When** comparing results
**Then** the system should:
- ✅ Latency simulation increases end-to-end time by expected amount
- ✅ Packet loss simulation increases retransmissions
- ✅ Jitter simulation increases latency variance
- ✅ Throughput decreases proportionally to packet loss
- ✅ Metrics collected show clear impact of network conditions

---

## Tasks/Subtasks

- [ ] Task 1: Docker Network Configuration (AC: 1)
  - [ ] Modify `test/docker/dassie-stack.yml` to use custom bridge network
  - [ ] Add network driver options for `tc` support
  - [ ] Test network creation and deletion
  - [ ] Document network architecture

- [ ] Task 2: Traffic Control Initialization Script (AC: 5)
  - [ ] Create file: `test/docker/scripts/apply-network-sim.sh`
  - [ ] Implement `tc qdisc` rule application
  - [ ] Add error handling and logging
  - [ ] Make script executable (`chmod +x`)
  - [ ] Test script with various configurations

- [ ] Task 3: Dockerfile Modifications (AC: 5)
  - [ ] Modify Dassie Dockerfile to install `iproute2` package (for `tc`)
  - [ ] Add entrypoint script to call `apply-network-sim.sh`
  - [ ] Ensure container has `CAP_NET_ADMIN` capability
  - [ ] Test Dockerfile builds successfully

- [ ] Task 4: Docker Compose Environment Variables (AC: 2, 3, 4)
  - [ ] Add `NETWORK_LATENCY`, `NETWORK_JITTER`, `NETWORK_PACKET_LOSS` to each service
  - [ ] Add `cap_add: NET_ADMIN` to services requiring `tc`
  - [ ] Test environment variable propagation
  - [ ] Document configuration options

- [ ] Task 5: Test Framework Integration (AC: 6)
  - [ ] Modify `createTestNetwork()` to accept `networkSimulation` config
  - [ ] Generate Docker Compose environment variables from config
  - [ ] Pass environment to `startDockerStack()`
  - [ ] Add unit tests for config transformation

- [ ] Task 6: Network Verification Utility (AC: 7)
  - [ ] Create file: `test/btp-nips/n-peer/network-verification.ts`
  - [ ] Implement `verifyNetworkConditions()` function
  - [ ] Add ping test implementation using Docker exec
  - [ ] Add packet loss measurement
  - [ ] Add jitter (latency variance) measurement
  - [ ] Add unit tests for verification logic

- [ ] Task 7: Integration Testing (AC: 8)
  - [ ] Test latency simulation (50ms, 100ms, 200ms)
  - [ ] Test packet loss simulation (1%, 5%, 10%)
  - [ ] Test jitter simulation (10ms, 20ms)
  - [ ] Test combined conditions (latency + jitter + packet loss)
  - [ ] Measure performance impact on BTP-NIPs event propagation
  - [ ] Compare with baseline (no simulation)

- [ ] Task 8: Documentation (AC: All)
  - [ ] Add JSDoc comments to network verification functions
  - [ ] Document `tc` command usage and configuration
  - [ ] Add troubleshooting guide for network simulation issues
  - [ ] Update Story 11.4 test documentation with simulation examples

---

## Dev Notes

### Traffic Control (tc) Basics

**`tc` Command Overview:**

`tc` (traffic control) is a Linux utility for configuring the kernel packet scheduler. It's part of the `iproute2` package.

**Key Concepts:**
- **qdisc (queueing discipline)**: Controls how packets are queued and sent
- **netem (network emulator)**: Emulates WAN conditions (latency, loss, jitter)
- **Interface**: Usually `eth0` in Docker containers

**Basic Commands:**

```bash
# Add latency (50ms)
tc qdisc add dev eth0 root netem delay 50ms

# Add latency with jitter (50ms ± 10ms)
tc qdisc add dev eth0 root netem delay 50ms 10ms

# Add packet loss (5%)
tc qdisc add dev eth0 root netem loss 5%

# Combine latency, jitter, and packet loss
tc qdisc add dev eth0 root netem delay 50ms 10ms loss 5%

# Show current qdisc
tc qdisc show dev eth0

# Delete qdisc (restore normal behavior)
tc qdisc del dev eth0 root
```

### Docker Integration

**Required Docker Capabilities:**

To use `tc` inside containers, the container needs `NET_ADMIN` capability:

```yaml
services:
  dassie-node-0:
    cap_add:
      - NET_ADMIN
```

**Entrypoint Pattern:**

```dockerfile
# Dockerfile
FROM debian:bookworm-slim

# Install iproute2 for tc
RUN apt-get update && apt-get install -y iproute2

# Copy scripts
COPY scripts/apply-network-sim.sh /usr/local/bin/
COPY scripts/entrypoint.sh /usr/local/bin/

# Make scripts executable
RUN chmod +x /usr/local/bin/apply-network-sim.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["dassie", "start"]
```

**Entrypoint Script (`scripts/entrypoint.sh`):**

```bash
#!/bin/bash
set -e

# Apply network simulation if configured
/usr/local/bin/apply-network-sim.sh

# Execute the main command (e.g., dassie start)
exec "$@"
```

### Test Framework Modifications

**Current `createTestNetwork()` Signature:**

```typescript
export async function createTestNetwork(
  nodeCount: number,
  config?: Partial<TestNetworkConfig>
): Promise<TestNode[]>
```

**Updated `startDockerStack()` to Accept Simulation Config:**

```typescript
async function startDockerStack(
  dockerComposePath: string,
  nodeCount: number,
  networkSimulation?: NetworkSimulationConfig
): Promise<void> {
  console.log(`Starting Docker stack: ${dockerComposePath}`)

  // Build environment variables for Docker Compose
  const envVars = buildNetworkSimulationEnv(networkSimulation)

  // Start Docker Compose with environment
  execSync(`docker-compose -f ${dockerComposePath} up -d`, {
    stdio: 'inherit',
    env: { ...process.env, ...envVars }
  })

  // Wait for containers to be healthy
  const containers = [
    'dassie-test-postgres',
    'dassie-test-redis',
    ...Array.from({ length: nodeCount }, (_, i) => `dassie-node-${i}`)
  ]

  for (const container of containers) {
    await waitForContainerHealthy(container, 60000)
  }

  // Verify network conditions if simulation enabled
  if (networkSimulation && (networkSimulation.latency > 0 || networkSimulation.packetLoss > 0)) {
    console.log('Verifying network simulation conditions...')
    const nodes = await Promise.all(
      Array.from({ length: nodeCount }, (_, i) => createNode(i, { networkSimulation }))
    )
    const verified = await verifyNetworkConditions(
      nodes,
      networkSimulation.latency,
      networkSimulation.packetLoss
    )
    if (!verified) {
      throw new Error('Network simulation verification failed')
    }
    console.log('✓ Network simulation verified')
  }

  console.log('✓ All Docker containers healthy')
}

function buildNetworkSimulationEnv(simulation?: NetworkSimulationConfig): Record<string, string> {
  if (!simulation) return {}

  const env: Record<string, string> = {}

  if (simulation.latency > 0) {
    env.NETWORK_LATENCY = `${simulation.latency}ms`
  }

  if (simulation.jitter > 0) {
    env.NETWORK_JITTER = `${simulation.jitter}ms`
  }

  if (simulation.packetLoss > 0) {
    env.NETWORK_PACKET_LOSS = `${simulation.packetLoss * 100}%`
  }

  return env
}
```

### Network Verification Implementation

**Ping Test via Docker Exec:**

```typescript
import { execSync } from 'child_process'

interface PingTestResult {
  averageLatency: number;
  minLatency: number;
  maxLatency: number;
  stdDevLatency: number;
  packetLoss: number;
  packetsSent: number;
  packetsReceived: number;
}

async function runPingTest(
  fromNode: TestNode,
  toNode: TestNode,
  count: number
): Promise<PingTestResult> {
  // Get target IP address from node's container
  const targetIp = getNodeIpAddress(toNode)
  const containerName = (fromNode.streamConnection as RealDassieConnection).containerName

  // Run ping inside container
  const output = execSync(
    `docker exec ${containerName} ping -c ${count} -W 1 ${targetIp}`,
    { encoding: 'utf-8' }
  )

  // Parse ping output
  return parsePingOutput(output)
}

function parsePingOutput(output: string): PingTestResult {
  // Parse lines like:
  // "64 bytes from 172.20.0.11: icmp_seq=1 ttl=64 time=52.3 ms"
  // "5 packets transmitted, 5 received, 0% packet loss, time 4005ms"
  // "rtt min/avg/max/mdev = 50.123/52.456/54.789/1.234 ms"

  const lines = output.split('\n')

  // Extract packet loss
  const packetLossLine = lines.find(l => l.includes('packet loss'))
  const packetLossMatch = packetLossLine?.match(/(\d+)% packet loss/)
  const packetLoss = packetLossMatch ? parseInt(packetLossMatch[1]) / 100 : 0

  // Extract RTT statistics
  const rttLine = lines.find(l => l.includes('rtt min/avg/max'))
  const rttMatch = rttLine?.match(/rtt min\/avg\/max\/mdev = ([\d.]+)\/([\d.]+)\/([\d.]+)\/([\d.]+)/)

  if (!rttMatch) {
    throw new Error('Failed to parse ping output')
  }

  return {
    minLatency: parseFloat(rttMatch[1]),
    averageLatency: parseFloat(rttMatch[2]),
    maxLatency: parseFloat(rttMatch[3]),
    stdDevLatency: parseFloat(rttMatch[4]),
    packetLoss,
    packetsSent: 100,
    packetsReceived: 100 * (1 - packetLoss)
  }
}

function getNodeIpAddress(node: TestNode): string {
  const connection = node.streamConnection as RealDassieConnection
  const containerName = connection.containerName

  // Extract IP from docker inspect
  const output = execSync(
    `docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${containerName}`,
    { encoding: 'utf-8' }
  ).trim()

  return output
}
```

### Expected Performance Impact

**Baseline (No Simulation):**
- Event propagation latency: ~10ms (in-memory)
- Throughput: 1000+ events/sec
- Packet loss: 0%

**With 50ms Latency:**
- Event propagation latency: ~60ms (50ms network + 10ms processing)
- Throughput: ~500 events/sec (limited by RTT)
- Packet loss: 0%

**With 5% Packet Loss:**
- Event propagation latency: ~10-50ms (retransmissions)
- Throughput: ~950 events/sec (5% need retry)
- Packet loss: 5% (first attempt)

**With 50ms Latency + 10ms Jitter + 2% Loss:**
- Event propagation latency: ~40-70ms (jitter causes variance)
- Throughput: ~450 events/sec
- Packet loss: 2% (first attempt)

### Testing Strategy

**Unit Tests:**
- Test `buildNetworkSimulationEnv()` function
- Test `parsePingOutput()` with various ping outputs
- Test Docker environment variable propagation

**Integration Tests:**
- Test `tc` rule application in container
- Test network verification with known conditions
- Test BTP-NIPs event propagation under various network conditions

**Performance Tests:**
- Measure event propagation latency distribution
- Measure throughput degradation vs. packet loss
- Measure retransmission rate vs. packet loss

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-16 | 1.0 | Initial story creation for Docker network simulation | Sarah (PO) |

---

## Dev Agent Record

*(To be populated during implementation)*

### Agent Model Used

### Debug Log References

### Completion Notes

### File List

**Created:**
- (List files created during implementation)

**Modified:**
- (List files modified during implementation)

---

## QA Results

*(To be populated by Quinn)*

**Network Simulation:**
- [ ] Latency simulation accurate (±10%): ☐ PASS ☐ FAIL
- [ ] Packet loss simulation accurate (±2%): ☐ PASS ☐ FAIL
- [ ] Jitter simulation accurate (±3ms): ☐ PASS ☐ FAIL

**Verification:**
- [ ] Network verification passes with correct config: ☐ PASS ☐ FAIL
- [ ] Network verification fails with incorrect config: ☐ PASS ☐ FAIL

**Performance Impact:**
- [ ] Latency increases propagation time: ☐ PASS ☐ FAIL
- [ ] Packet loss decreases throughput: ☐ PASS ☐ FAIL

**Recommendation:** ☐ PASS ☐ PASS with CONCERNS ☐ FAIL

---

## References

- **Story 11.4:** Docker Dassie Integration (`docs/stories/11.4.story.md`)
- **Story 11.1:** N-Peer Test Framework Infrastructure (`docs/stories/11.1.story.md`)
- **Linux `tc` Manual:** https://man7.org/linux/man-pages/man8/tc.8.html
- **netem (Network Emulator):** https://wiki.linuxfoundation.org/networking/netem
- **Docker Compose Networking:** https://docs.docker.com/compose/networking/
- **iproute2 Package:** https://packages.debian.org/bookworm/iproute2
