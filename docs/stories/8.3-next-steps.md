# Story 8.3: Next Steps for Mainnet Deployment

## Current Status

✅ **Research Complete**: Akash CLI identified as working solution
✅ **Container Ready**: Akash CLI installed in Docker image
✅ **API Ready**: Self-hosting API implemented (`/api/akash/*`)
⏳ **Mainnet Deployment**: Pending execution

---

## Immediate Actions Required

### 1. Build Updated Docker Image

The Dockerfile now includes Akash CLI. Build and verify:

```bash
# Build image
docker build -t nostream-ilp:latest .

# Verify CLI is installed
docker run --rm nostream-ilp:latest akash version
# Expected: v1.1.1 or later
```

### 2. Install Akash CLI Locally (for manual deployment)

```bash
# macOS
brew install akash

# Or direct install
curl https://raw.githubusercontent.com/akash-network/node/master/install.sh | sh

# Verify
akash version
```

### 3. Setup Mainnet Wallet

```bash
# Option A: Create new wallet
akash keys add mainnet-wallet --keyring-backend test

# Option B: Import existing wallet
akash keys add mainnet-wallet --recover --keyring-backend test
# (paste mnemonic when prompted)

# Verify wallet
akash keys show mainnet-wallet -a
```

### 4. Fund Wallet with AKT

**Required**: Minimum 5 AKT (~$25 at $5/AKT)

**Where to buy AKT**:
- Coinbase: https://www.coinbase.com/price/akash-network
- Kraken: https://www.kraken.com
- Osmosis DEX: https://app.osmosis.zone

**Send to wallet address**:
```bash
akash keys show mainnet-wallet -a
# Send AKT to this address
```

**Verify balance**:
```bash
akash query bank balances $(akash keys show mainnet-wallet -a) \
  --node https://rpc.akashnet.net:443
```

---

## Deployment Methods

### Method 1: Manual CLI Deployment (Recommended First Time)

```bash
# Step 1: Deploy
akash tx deployment create akash/deploy.yaml \
  --from mainnet-wallet \
  --node https://rpc.akashnet.net:443 \
  --chain-id akashnet-2 \
  --keyring-backend test \
  --gas auto \
  --gas-prices 0.025uakt \
  --gas-adjustment 1.5 \
  --yes

# Step 2: Note DSEQ from output
# Example: "dseq: 123456"

# Step 3: Wait for bids (1-3 minutes)
akash query market bid list \
  --owner $(akash keys show mainnet-wallet -a) \
  --dseq 123456 \
  --node https://rpc.akashnet.net:443

# Step 4: Accept lowest bid
# Get provider address from bid list, then:
akash tx market lease create \
  --dseq 123456 \
  --gseq 1 \
  --oseq 1 \
  --provider <PROVIDER_ADDRESS> \
  --from mainnet-wallet \
  --node https://rpc.akashnet.net:443 \
  --chain-id akashnet-2 \
  --keyring-backend test \
  --gas auto \
  --gas-prices 0.025uakt \
  --yes

# Step 5: Wait 5-10 minutes for deployment

# Step 6: Check logs
akash provider service-logs \
  --dseq 123456 \
  --provider <PROVIDER_ADDRESS> \
  --from mainnet-wallet \
  --node https://rpc.akashnet.net:443 \
  --keyring-backend test
```

---

### Method 2: Bash Script Wrapper

Create `scripts/akash-cli-deploy.sh`:

```bash
#!/bin/bash
set -euo pipefail

# Configuration
AKASH_FROM="mainnet-wallet"
AKASH_NODE="https://rpc.akashnet.net:443"
AKASH_CHAIN_ID="akashnet-2"
SDL_FILE="akash/deploy.yaml"

# Check balance
echo "Checking balance..."
BALANCE=$(akash query bank balances $(akash keys show $AKASH_FROM -a) \
  --node $AKASH_NODE --output json | jq -r '.balances[0].amount')
BALANCE_AKT=$((BALANCE / 1000000))
echo "Balance: $BALANCE_AKT AKT"

if [ $BALANCE_AKT -lt 5 ]; then
  echo "Error: Insufficient balance"
  exit 1
fi

# Deploy
echo "Creating deployment..."
akash tx deployment create $SDL_FILE \
  --from $AKASH_FROM \
  --node $AKASH_NODE \
  --chain-id $AKASH_CHAIN_ID \
  --keyring-backend test \
  --gas auto \
  --gas-prices 0.025uakt \
  --gas-adjustment 1.5 \
  --yes

echo "Deployment created! Check bids with:"
echo "  akash query market bid list --owner \$(akash keys show $AKASH_FROM -a) --node $AKASH_NODE"
```

Run:
```bash
chmod +x scripts/akash-cli-deploy.sh
./scripts/akash-cli-deploy.sh
```

---

### Method 3: API-Based Deployment (Container Self-Hosting)

Once the container is running with Akash CLI installed:

```bash
# Check CLI status
curl http://localhost:8008/api/akash/status

# Create wallet
curl -X POST http://localhost:8008/api/akash/wallet/create \
  -H "Content-Type: application/json" \
  -d '{"walletName":"peer-wallet"}'

# Check balance
curl http://localhost:8008/api/akash/wallet/peer-wallet/balance?network=mainnet

# Deploy
curl -X POST http://localhost:8008/api/akash/deploy \
  -H "Content-Type: application/json" \
  -d '{
    "walletName": "peer-wallet",
    "network": "mainnet"
  }'
```

---

## Before You Deploy: Checklist

- [ ] Docker image built with Akash CLI
- [ ] Akash CLI installed locally (for manual deployment)
- [ ] Mainnet wallet created (`mainnet-wallet`)
- [ ] Wallet funded with ≥5 AKT
- [ ] Balance verified via CLI
- [ ] SDL file reviewed (`akash/deploy.yaml`)
- [ ] Image tags updated from `:latest` to specific version (if using custom images)
- [ ] RPC endpoint verified: `https://rpc.akashnet.net:443`

---

## After Deployment: Verification

### Get Deployment Status

```bash
akash query deployment get \
  --owner $(akash keys show mainnet-wallet -a) \
  --dseq 123456 \
  --node https://rpc.akashnet.net:443
```

### Get Lease Status

```bash
akash query market lease get \
  --owner $(akash keys show mainnet-wallet -a) \
  --dseq 123456 \
  --provider <PROVIDER_ADDRESS> \
  --node https://rpc.akashnet.net:443
```

### Get Service URI

```bash
akash provider lease-status \
  --dseq 123456 \
  --provider <PROVIDER_ADDRESS> \
  --from mainnet-wallet \
  --node https://rpc.akashnet.net:443 \
  --keyring-backend test
```

### Test Service

```bash
# Get URI from lease-status output
curl https://<provider-uri>:8080/health

# Expected:
# {"status":"healthy","services":{...}}
```

---

## Troubleshooting

### Issue: "Insufficient balance"
**Solution**: Fund wallet with at least 5 AKT

### Issue: "No bids received"
**Solutions**:
- Wait longer (up to 5 minutes)
- Check SDL pricing (may be too low)
- Try different RPC endpoint
- Verify SDL syntax

### Issue: "Certificate PEM error"
**Solution**: This was the old issue - CLI method doesn't use certificates for deployment (only for provider communication)

### Issue: "gRPC protocol error"
**Solution**: This was the SDK issue - CLI uses REST/RPC, not gRPC

---

## Cost Estimate

| Item | AKT | USD (@ $5/AKT) |
|------|-----|----------------|
| Initial deposit | 5.0 | $25.00 |
| Month 1 hosting | ~1.0 | ~$5.00 |
| Transaction fees | ~0.01 | ~$0.05 |
| **Total Month 1** | **~6.0** | **~$30.00** |
| **Subsequent months** | **~1.0** | **~$5.00** |

---

## Success Criteria

Deployment is successful when:

1. ✅ Deployment transaction confirmed (DSEQ obtained)
2. ✅ Provider bid received and accepted
3. ✅ Lease created successfully
4. ✅ Containers start (verified via logs)
5. ✅ Health endpoint returns `{"status":"healthy"}`
6. ✅ Service accessible via provider URI
7. ✅ Cost ≤$10/month (1,150 uAKT/block) [Updated Story 2.13]

---

## Documentation References

- **Research Report**: See Story 8.3, "Research Findings" section
- **Self-Hosting API**: `docs/akash-self-hosting.md`
- **Akash CLI Docs**: https://docs.akash.network/cli
- **Working Endpoints**: https://rpc.akashnet.net:443

---

**Ready to Deploy**: Follow Method 1 (Manual CLI) for first deployment. Once comfortable, automate with Method 2 (Bash Script) or Method 3 (API).

**Estimated Time**: 30 minutes preparation + 15 minutes deployment + 10 minutes verification = **~1 hour total**

**Confidence Level**: 85% (based on research findings)
