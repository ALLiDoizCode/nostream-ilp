# Story 5.9: Dassie tRPC Endpoints for Test Integration

**Epic:** 5 - BTP-NIPs Core Protocol
**Status:** Draft
**Priority:** High (Blocker for Story 11.4)
**Estimated Effort:** 3 days
**Created:** 2025-12-16
**Dependencies:** Story 2.10 (Dassie Monorepo Integration)

---

## Story

**As a** QA Engineer,
**I want** Dassie to expose tRPC endpoints for test framework integration,
**so that** Story 11.4 real Dassie integration tests can query peer status, send payments, and inspect internal ledger state.

---

## Acceptance Criteria

### AC 1: tRPC Endpoint - peers.list

**Given** Dassie node is running with active peer connections
**When** test framework calls `trpc.peers.list()`
**Then** the endpoint should return:
- ✅ Array of peer information objects
- ✅ Each peer object contains: `ilpAddress`, `status`, `lastHeartbeat`, `connectedAt`
- ✅ Status values: `'pending' | 'established' | 'active' | 'disconnected'`
- ✅ Response time < 100ms

**Example Response:**
```typescript
{
  result: {
    data: [
      {
        ilpAddress: 'g.dassie.node1',
        status: 'active',
        lastHeartbeat: 1702745600000,
        connectedAt: 1702745000000
      },
      {
        ilpAddress: 'g.dassie.node2',
        status: 'established',
        lastHeartbeat: 1702745590000,
        connectedAt: 1702745100000
      }
    ]
  }
}
```

### AC 2: tRPC Endpoint - peers.count

**Given** Dassie node has N active peer connections
**When** test framework calls `trpc.peers.count()`
**Then** the endpoint should return:
- ✅ Integer count of active peer connections
- ✅ Only counts peers with status 'active' or 'established'
- ✅ Response time < 50ms

**Example Response:**
```typescript
{
  result: {
    data: 2
  }
}
```

### AC 3: tRPC Endpoint - ilp.sendPayment

**Given** Dassie node with sufficient balance
**When** test framework calls `trpc.ilp.sendPayment({ destination, amount, currency, timeout })`
**Then** the endpoint should:
- ✅ Initiate ILP payment to destination address
- ✅ Return payment ID immediately (async operation)
- ✅ Payment object contains: `id`, `status`, `hops`, `amountDelivered`, `error`
- ✅ Status starts as `'pending'`
- ✅ Response time < 200ms

**Example Request:**
```typescript
{
  destination: 'g.dassie.node4',
  amount: 100,
  currency: 'msat',
  timeout: 5000
}
```

**Example Response:**
```typescript
{
  result: {
    data: {
      id: 'payment_abc123',
      status: 'pending',
      hops: 0,
      amountDelivered: null,
      error: null
    }
  }
}
```

### AC 4: tRPC Endpoint - ilp.getPaymentStatus

**Given** a payment was initiated with ID
**When** test framework calls `trpc.ilp.getPaymentStatus({ id })`
**Then** the endpoint should:
- ✅ Return current payment status
- ✅ Status values: `'pending' | 'fulfilled' | 'failed'`
- ✅ Include `hops`, `amountDelivered`, `error` if available
- ✅ Response time < 50ms

**Example Response (fulfilled):**
```typescript
{
  result: {
    data: {
      id: 'payment_abc123',
      status: 'fulfilled',
      hops: 3,
      amountDelivered: '70', // after fees
      error: null
    }
  }
}
```

**Example Response (failed):**
```typescript
{
  result: {
    data: {
      id: 'payment_xyz789',
      status: 'failed',
      hops: 1,
      amountDelivered: null,
      error: 'Insufficient liquidity at hop 1'
    }
  }
}
```

### AC 5: tRPC Endpoint - ledger.getState

**Given** Dassie internal ledger with transactions
**When** test framework calls `trpc.ledger.getState()`
**Then** the endpoint should return:
- ✅ Current balance in base units (msats)
- ✅ Pending balance (in-flight payments)
- ✅ Routing revenue earned
- ✅ Fees paid
- ✅ Optionally: array of account entries (path, debit, credit)
- ✅ Response time < 100ms

**Example Response:**
```typescript
{
  result: {
    data: {
      balance: 5000,
      pendingBalance: 150,
      routingRevenue: 230,
      feesPaid: 45,
      accounts: [
        { path: 'xrp:assets/settlement', debit: 10000, credit: 5000 },
        { path: 'xrp:liabilities/peerA/interledger', debit: 2000, credit: 3000 }
      ]
    }
  }
}
```

### AC 6: Authentication & Authorization

**Given** test framework with authentication token
**When** calling any tRPC endpoint
**Then** the system should:
- ✅ Validate `Authorization: Bearer <token>` header
- ✅ Reject unauthenticated requests with 401 status
- ✅ Reject invalid tokens with 403 status
- ✅ Accept valid tokens and process request

### AC 7: Error Handling

**Given** various error conditions
**When** tRPC endpoints encounter errors
**Then** the system should:
- ✅ Return structured error responses
- ✅ Include error code, message, and details
- ✅ Log errors appropriately (no sensitive data in logs)
- ✅ Handle network errors gracefully

**Error Response Format:**
```typescript
{
  error: {
    code: 'PAYMENT_FAILED',
    message: 'Insufficient balance for payment',
    details: {
      required: 1000,
      available: 500
    }
  }
}
```

---

## Tasks/Subtasks

- [ ] Task 1: Create tRPC Router Infrastructure (AC: All)
  - [ ] Create file: `packages/app-dassie/src/backend/rpc/test-router.ts`
  - [ ] Import tRPC dependencies: `@trpc/server`
  - [ ] Define router with authentication middleware
  - [ ] Export router for integration with existing Dassie RPC server

- [ ] Task 2: Implement peers.list Endpoint (AC: 1)
  - [ ] Query Dassie peer manager for active peers
  - [ ] Map peer data to response format
  - [ ] Include status, heartbeat, connection timestamps
  - [ ] Add unit tests for endpoint

- [ ] Task 3: Implement peers.count Endpoint (AC: 2)
  - [ ] Count active/established peer connections
  - [ ] Filter out disconnected peers
  - [ ] Add unit tests for endpoint

- [ ] Task 4: Implement ilp.sendPayment Endpoint (AC: 3)
  - [ ] Validate payment request parameters
  - [ ] Initiate ILP payment via Dassie payment manager
  - [ ] Generate unique payment ID
  - [ ] Return payment status object
  - [ ] Add unit tests for endpoint

- [ ] Task 5: Implement ilp.getPaymentStatus Endpoint (AC: 4)
  - [ ] Query payment manager for payment status
  - [ ] Return current status with details
  - [ ] Handle payment not found errors
  - [ ] Add unit tests for endpoint

- [ ] Task 6: Implement ledger.getState Endpoint (AC: 5)
  - [ ] Query Dassie internal ledger (SQLite)
  - [ ] Aggregate account balances
  - [ ] Calculate routing revenue and fees
  - [ ] Format response with account entries
  - [ ] Add unit tests for endpoint

- [ ] Task 7: Add Authentication Middleware (AC: 6)
  - [ ] Implement Bearer token validation
  - [ ] Load auth tokens from config.json
  - [ ] Add 401/403 error responses
  - [ ] Add unit tests for authentication

- [ ] Task 8: Add Error Handling (AC: 7)
  - [ ] Wrap endpoints in try-catch blocks
  - [ ] Return structured error responses
  - [ ] Add logging for errors
  - [ ] Add unit tests for error scenarios

- [ ] Task 9: Integration Testing (AC: All)
  - [ ] Test all endpoints with real Dassie node
  - [ ] Verify response formats match spec
  - [ ] Test error scenarios (invalid tokens, network errors)
  - [ ] Verify performance targets met

- [ ] Task 10: Documentation (AC: All)
  - [ ] Add JSDoc comments to all endpoints
  - [ ] Document authentication requirements
  - [ ] Add usage examples in comments
  - [ ] Update Dassie README with new endpoints

---

## Dev Notes

### Architecture Context

**Dassie tRPC Server:**

From the monorepo structure [Source: docs/architecture/source-tree-structure.md]:
- Dassie uses tRPC for inter-process communication
- Existing RPC server in `packages/app-dassie/src/backend/rpc/`
- Port: 7768 (configurable via config)

**Integration Point:**

These endpoints extend Dassie's existing tRPC router to expose test-friendly APIs. They do NOT modify the core Dassie protocol, only add observability endpoints for testing.

**Authentication:**

From Story 11.4 config files [Source: docs/stories/11.4.story.md]:
- Auth tokens defined in node config.json: `rpc.authToken`
- Example: `"authToken": "test-token-node0"`
- Validate via `Authorization: Bearer <token>` header

### Peer Management

**Dassie Peer Architecture:**

From CLAUDE.md [Source: CLAUDE.md lines 199-276]:
- Peers managed via BNL (Bootstrap Node List) and KNL (Known Node List)
- Peer status tracked: pending, established, active, disconnected
- Heartbeat messages sent every 5-20 seconds (adaptive)

**Implementation Notes:**
- Query Dassie's peer manager (if available) or peer store
- Filter peers by status for `peers.count`
- Include heartbeat timestamps for `peers.list`

### ILP Payment Flow

**Dassie Payment Manager:**

Payments in Dassie are asynchronous:
1. `sendPayment` initiates payment, returns payment ID
2. Payment routes through ILP network (multi-hop)
3. `getPaymentStatus` polls for completion

**Payment States:**
- `pending`: Payment initiated, routing in progress
- `fulfilled`: Payment delivered, fulfillment received
- `failed`: Payment failed (timeout, insufficient liquidity, etc.)

### Internal Ledger

**Dassie Double-Entry Accounting:**

From CLAUDE.md [Source: CLAUDE.md lines 215-230]:
- Account types: asset, liability, equity, revenue, expense
- Account paths: `xrp:assets/settlement`, `xrp:liabilities/peerA/interledger`
- Stored in SQLite database

**Ledger Query:**
- Aggregate balances from account entries
- Calculate routing revenue (fees collected)
- Calculate fees paid (routing costs)

### Testing

**Test File Locations:**
- Unit tests: `packages/app-dassie/src/backend/rpc/test-router.spec.ts`
- Integration tests: Use Story 11.4 test suite once implemented

**Test Standards:**
- Use Vitest for unit testing
- Mock Dassie peer manager, payment manager, ledger
- Verify response formats match TypeScript interfaces
- Test authentication middleware (valid/invalid tokens)

**Testing Frameworks:**
- Vitest 1.x for unit tests
- tRPC client for endpoint testing
- Verify error handling and edge cases

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-16 | 1.0 | Initial story creation for Dassie tRPC test endpoints | Sarah (PO) |

---

## Dev Agent Record

*(To be populated during implementation)*

### Agent Model Used

### Debug Log References

### Completion Notes

### File List

**Created:**
- (List files created during implementation)

**Modified:**
- (List files modified during implementation)

---

## QA Results

*(To be populated by Quinn)*

**Endpoint Testing:**
- [ ] peers.list returns correct data: ☐ PASS ☐ FAIL
- [ ] ilp.sendPayment initiates payment: ☐ PASS ☐ FAIL
- [ ] ledger.getState shows accurate balances: ☐ PASS ☐ FAIL

**Recommendation:** ☐ PASS ☐ PASS with CONCERNS ☐ FAIL

---

## References

- **Story 11.4:** Docker Dassie Integration (`docs/stories/11.4.story.md`)
- **Dassie Architecture:** CLAUDE.md (Internal Ledger, Peer Management)
- **Monorepo Structure:** `docs/architecture/source-tree-structure.md`
- **tRPC Documentation:** https://trpc.io/docs/server/routers
