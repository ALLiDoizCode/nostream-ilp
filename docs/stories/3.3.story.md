# Story 3.3: Configure Hardhat for Cronos and Create Deployment Scripts

## Status

Done

## Story

**As a** developer,
**I want** Hardhat configured for Cronos deployment with proper scripts,
**so that** I can deploy to testnet and mainnet.

## Acceptance Criteria

1. Update `hardhat.config.ts`:
   ```typescript
   networks: {
     "cronos-testnet": {
       url: "https://evm-t3.cronos.org:8545/",
       accounts: [process.env.PRIVATE_KEY!],
       chainId: 338,
     },
     "cronos-mainnet": {
       url: "https://evm.cronos.org",
       accounts: [process.env.PRIVATE_KEY!],
       chainId: 25,
     }
   }
   ```
2. Add CronoScan verification config:
   ```typescript
   etherscan: {
     apiKey: {
       "cronos-testnet": process.env.CRONOSCAN_API_KEY,
       "cronos-mainnet": process.env.CRONOSCAN_API_KEY,
     },
     customChains: [/* Cronos testnet/mainnet config */]
   }
   ```
3. Create deployment script: `scripts/deploy-cronos-testnet.ts`
   - Deploy MockAKT token
   - Deploy CronosPaymentChannel with MockAKT address
   - Mint test AKT to deployer
   - Log all addresses
4. Create deployment script: `scripts/deploy-cronos-mainnet.ts`
   - Use real AKT address: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`
   - Deploy CronosPaymentChannel only
5. Update `.env.example` with Cronos variables
6. Local compilation succeeds: `npx hardhat compile`
7. Documentation: Deployment instructions in README

## Tasks / Subtasks

- [x] Task 1: Update Hardhat Configuration with Cronos Networks (AC: 1)
  - [x] Read current `hardhat.config.ts` structure
  - [x] Add `networks` section with Cronos testnet and mainnet
    - [x] Cronos testnet: URL `https://evm-t3.cronos.org:8545/`, chainId `338`
    - [x] Cronos mainnet: URL `https://evm.cronos.org`, chainId `25`
    - [x] Both networks use `process.env.PRIVATE_KEY` for deployer account
  - [x] Add error handling for missing `PRIVATE_KEY` environment variable
  - [x] Verify configuration compiles: `npx hardhat compile`

- [x] Task 2: Add CronoScan Verification Configuration (AC: 2)
  - [x] Add `etherscan` section to Hardhat config
  - [x] Configure API key from `process.env.CRONOSCAN_API_KEY`
  - [x] Add `customChains` array with Cronos testnet and mainnet configurations:
    - [x] Cronos testnet: chainId 338, API URL `https://explorer-api-testnet.cronos.org/api`
    - [x] Cronos mainnet: chainId 25, API URL `https://explorer-api.cronos.org/api`
  - [x] Document CronoScan explorer URLs:
    - [x] Testnet: `https://testnet.cronoscan.com`
    - [x] Mainnet: `https://cronoscan.com`

- [x] Task 3: Create Cronos Testnet Deployment Script (AC: 3)
  - [x] Create file: `scripts/deploy-cronos-testnet.ts`
  - [x] Import required dependencies:
    - [x] `ethers` from `hardhat`
    - [x] `run` from `hardhat` (for verification)
  - [x] Implement deployment flow:
    1. [x] Get deployer signer and log deployer address
    2. [x] Deploy MockAKT token contract
    3. [x] Wait for MockAKT deployment confirmation
    4. [x] Log MockAKT contract address
    5. [x] Deploy CronosPaymentChannel with MockAKT address as constructor parameter
    6. [x] Wait for CronosPaymentChannel deployment confirmation
    7. [x] Log CronosPaymentChannel contract address
    8. [x] Mint test AKT to deployer (e.g., 10,000 AKT = `ethers.parseUnits("10000", 6)`)
    9. [x] Wait for mint transaction confirmation
    10. [x] Log deployer's AKT balance
  - [x] Add comprehensive logging:
    - [x] Log network name and chainId
    - [x] Log each transaction hash
    - [x] Log final deployed addresses summary
  - [x] Add TypeScript types for deployment results
  - [x] Add error handling for deployment failures

- [x] Task 4: Create Cronos Mainnet Deployment Script (AC: 4)
  - [x] Create file: `scripts/deploy-cronos-mainnet.ts`
  - [x] Import required dependencies (same as testnet script)
  - [x] Define mainnet AKT token address constant: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`
  - [x] Implement deployment flow:
    1. [x] Get deployer signer and log deployer address
    2. [x] Log mainnet AKT token address being used
    3. [x] Deploy CronosPaymentChannel with mainnet AKT address
    4. [x] Wait for deployment confirmation
    5. [x] Log CronosPaymentChannel contract address
  - [x] Add safety confirmation prompt (optional):
    - [x] Warn about mainnet deployment costs
    - [x] Display estimated gas cost
  - [x] Add comprehensive logging similar to testnet script
  - [x] Add error handling for deployment failures

- [x] Task 5: Update Environment Configuration (AC: 5)
  - [x] Add Cronos-specific environment variables to `.env.example`:
    ```bash
    # ============================================================================
    # Cronos Deployment Configuration (Epic 3)
    # ============================================================================

    # Private key for deployer account (NEVER commit to version control)
    # Generate with: npx hardhat account create
    # Fund testnet wallet: https://cronos.org/faucet
    PRIVATE_KEY=

    # CronoScan API key for contract verification
    # Obtain from: https://cronoscan.com/myapikey (create free account)
    CRONOSCAN_API_KEY=

    # Deployed contract addresses (populated after deployment)
    # Testnet
    CRONOS_TESTNET_MOCK_AKT_ADDRESS=
    CRONOS_TESTNET_CHANNEL_ADDRESS=

    # Mainnet
    CRONOS_MAINNET_AKT_ADDRESS=0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3
    CRONOS_MAINNET_CHANNEL_ADDRESS=
    ```
  - [x] Add explanatory comments for each variable
  - [x] Document where to obtain API keys and faucet tokens

- [x] Task 6: Verify Local Compilation (AC: 6)
  - [x] Run: `npx hardhat compile`
  - [x] Verify no compilation errors
  - [x] Verify TypeChain types generated for contracts
  - [x] Test Hardhat config loads correctly: `npx hardhat config`
  - [x] Verify network configurations appear in output

- [x] Task 7: Create Deployment Documentation (AC: 7)
  - [x] Add "Deployment" section to project README (or create separate `docs/deployment.md`)
  - [x] Document prerequisites:
    - [x] Node.js 22.x LTS installed
    - [x] Hardhat dependencies installed: `npm install`
    - [x] Environment variables configured in `.env`
    - [x] Deployer account funded with CRO tokens
  - [x] Document testnet deployment process:
    1. [x] Configure `.env` with `PRIVATE_KEY` and `CRONOSCAN_API_KEY`
    2. [x] Get testnet CRO from faucet: `https://cronos.org/faucet`
    3. [x] Run deployment: `npx hardhat run scripts/deploy-cronos-testnet.ts --network cronos-testnet`
    4. [x] Save deployed addresses to `.env`
    5. [x] Verify contracts: `npx hardhat verify --network cronos-testnet <ADDRESS> <CONSTRUCTOR_ARGS>`
  - [x] Document mainnet deployment process:
    1. [x] Double-check `.env` configuration
    2. [x] Ensure deployer account has sufficient CRO (~10 CRO for deployment + gas)
    3. [x] Run deployment: `npx hardhat run scripts/deploy-cronos-mainnet.ts --network cronos-mainnet`
    4. [x] Save deployed address to `.env`
    5. [x] Verify contract: `npx hardhat verify --network cronos-mainnet <ADDRESS> 0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`
  - [x] Document common troubleshooting issues:
    - [x] "Missing PRIVATE_KEY" → Add to `.env` file
    - [x] "Insufficient funds" → Get CRO from faucet or exchange
    - [x] "Nonce too low" → Wait or reset account nonce
    - [x] "Verification failed" → Check API key and constructor args match

## Dev Notes

### Previous Story Context

**Story 3.2 Completion:**
Story 3.2 successfully created comprehensive test suite for CronosPaymentChannel.sol with 29 tests achieving 100% statement, function, and line coverage. MockAKT token contract created with proper 6-decimal precision. All tests passing in 722ms with zero defects found during QA review.

**Key Implementation Details from Story 3.2:**
- MockAKT contract: `contracts/test/MockAKT.sol` (ERC-20 with 6 decimals, mint function for testing)
- Test suite: `test/CronosPaymentChannel.test.ts` (29 tests, 683 lines)
- Coverage: 100% statement/function/line, 82.35% branch
- Test documentation: `test/README.md` (296 lines)

**Story 3.1 Completion:**
Story 3.1 created `CronosPaymentChannel.sol` (ERC-20 AKT version) with 95% code reuse from `BasePaymentChannel.sol`. Contract compiled successfully with all ERC-20 transfer return values properly checked with `require()` statements.

[Source: docs/stories/3.2.story.md, docs/stories/3.1.story.md]

---

### Story Dependencies

**Blockers:**
- Story 3.2 MUST be complete (status: Done) - Test suite validates contracts are ready for deployment

**Prerequisites:**
- Hardhat 2.x installed and configured (from Story 3.1)
- Contracts compiled successfully: `CronosPaymentChannel.sol`, `MockAKT.sol`
- TypeChain types generated for contracts
- Test suite passing (29/29 tests)

**Outputs for Future Stories:**
- Story 3.4 (Testnet Deployment): Will use `deploy-cronos-testnet.ts` script to deploy contracts
- Story 3.5 (Dassie Settlement): Will reference deployed contract addresses from this story's deployment

[Source: docs/prd/epic-3-cosmwasm-payment-channel-contract.md]

---

### Technology Stack for This Story

**Build Tools:**
- **Hardhat:** 2.x (Ethereum development environment)
- **TypeScript:** 5.3+ (Type-safe deployment scripts)
- **ethers.js:** v6 (via hardhat-toolbox)

**Network Configuration:**
- **Cronos Testnet:** EVM-compatible testnet (chainId 338)
- **Cronos Mainnet:** Production EVM network (chainId 25)
- **CronoScan:** Block explorer and contract verification service

**Deployment Tools:**
- **Hardhat Network Helpers:** Transaction waiting, gas estimation
- **Hardhat Verify Plugin:** Contract verification on CronoScan
- **dotenv:** Environment variable management

[Source: docs/architecture/tech-stack.md]

---

### Hardhat Configuration Specifications

**Current Configuration (Story 3.1):**
```typescript
// hardhat.config.ts
import type { HardhatUserConfig } from "hardhat/config";
import "@nomicfoundation/hardhat-toolbox";

const config: HardhatUserConfig = {
  solidity: {
    version: "0.8.20",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200
      }
    }
  }
};

export default config;
```

**Required Additions for This Story:**

1. **Networks Configuration:**
   - Cronos testnet: `https://evm-t3.cronos.org:8545/` (chainId 338)
   - Cronos mainnet: `https://evm.cronos.org` (chainId 25)
   - Both require `PRIVATE_KEY` environment variable for deployment

2. **Etherscan Verification:**
   - Plugin: `@nomicfoundation/hardhat-verify` (included in hardhat-toolbox)
   - API key: `CRONOSCAN_API_KEY` environment variable
   - Custom chains required because Cronos is not in Hardhat's default chain registry

3. **Environment Variables:**
   - `PRIVATE_KEY`: Deployer account private key (64 hex chars, no 0x prefix)
   - `CRONOSCAN_API_KEY`: CronoScan API key for contract verification

**Reference Implementation:**
```typescript
// Example from docs/research/cronos-akt-deployment/findings/deployment-guide.md
networks: {
  "cronos-testnet": {
    url: "https://evm-t3.cronos.org:8545/",
    accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [],
    chainId: 338,
    gasPrice: "auto" // Optional: let Hardhat estimate
  },
  "cronos-mainnet": {
    url: "https://evm.cronos.org",
    accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [],
    chainId: 25,
    gasPrice: "auto"
  }
}

etherscan: {
  apiKey: {
    "cronos-testnet": process.env.CRONOSCAN_API_KEY || "",
    "cronos-mainnet": process.env.CRONOSCAN_API_KEY || "",
  },
  customChains: [
    {
      network: "cronos-testnet",
      chainId: 338,
      urls: {
        apiURL: "https://explorer-api-testnet.cronos.org/api",
        browserURL: "https://testnet.cronoscan.com"
      }
    },
    {
      network: "cronos-mainnet",
      chainId: 25,
      urls: {
        apiURL: "https://explorer-api.cronos.org/api",
        browserURL: "https://cronoscan.com"
      }
    }
  ]
}
```

[Source: Hardhat documentation, docs/research/cronos-akt-deployment/findings/deployment-guide.md]

---

### Deployment Script Specifications

**Testnet Deployment Script (`scripts/deploy-cronos-testnet.ts`):**

**Purpose:** Deploy MockAKT and CronosPaymentChannel to Cronos testnet for testing before mainnet deployment.

**Flow:**
1. Get deployer signer from Hardhat runtime
2. Deploy MockAKT contract (no constructor args)
3. Deploy CronosPaymentChannel with MockAKT address
4. Mint test AKT to deployer for testing channel operations
5. Log all deployed addresses and transaction hashes

**Key Considerations:**
- Use `parseUnits(..., 6)` for AKT amounts (6 decimals, not 18)
- Wait for transaction confirmations to ensure deployment succeeded
- Log deployer balance to verify mint succeeded
- Save deployed addresses for use in Story 3.4 (manual testing)

**Example Structure:**
```typescript
import { ethers } from "hardhat";

async function main() {
  const [deployer] = await ethers.getSigners();
  console.log("Deploying with account:", deployer.address);

  // Deploy MockAKT
  const MockAKT = await ethers.getContractFactory("MockAKT");
  const aktToken = await MockAKT.deploy();
  await aktToken.waitForDeployment();
  console.log("MockAKT deployed to:", await aktToken.getAddress());

  // Deploy CronosPaymentChannel
  const PaymentChannel = await ethers.getContractFactory("CronosPaymentChannel");
  const channel = await PaymentChannel.deploy(await aktToken.getAddress());
  await channel.waitForDeployment();
  console.log("CronosPaymentChannel deployed to:", await channel.getAddress());

  // Mint test AKT
  const mintAmount = ethers.parseUnits("10000", 6); // 10k AKT
  const mintTx = await aktToken.mint(deployer.address, mintAmount);
  await mintTx.wait();
  console.log("Minted", ethers.formatUnits(mintAmount, 6), "AKT to deployer");

  // Verify balance
  const balance = await aktToken.balanceOf(deployer.address);
  console.log("Deployer AKT balance:", ethers.formatUnits(balance, 6), "AKT");

  console.log("\nDeployment Summary:");
  console.log("  MockAKT:", await aktToken.getAddress());
  console.log("  CronosPaymentChannel:", await channel.getAddress());
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
```

**Mainnet Deployment Script (`scripts/deploy-cronos-mainnet.ts`):**

**Purpose:** Deploy CronosPaymentChannel to Cronos mainnet using real AKT token address.

**Flow:**
1. Get deployer signer
2. Verify deployer has sufficient CRO for gas
3. Deploy CronosPaymentChannel with mainnet AKT address: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`
4. Log deployed address and transaction hash

**Key Differences from Testnet:**
- No MockAKT deployment (use real AKT token)
- Add safety warnings about mainnet deployment
- Optionally add gas estimation before deployment
- More conservative logging (production environment)

**Security Considerations:**
- Never log private keys or sensitive data
- Verify network before deployment (check chainId)
- Add confirmation prompt for mainnet (optional but recommended)
- Document estimated gas costs in deployment guide

[Source: docs/research/cronos-akt-deployment/findings/deployment-guide.md]

---

### File Locations and Naming Conventions

**New Files Created in This Story:**
```
nostream-ilp/                     # Project root
├── scripts/                      # NEW: Deployment scripts
│   ├── deploy-cronos-testnet.ts  # NEW: Testnet deployment
│   └── deploy-cronos-mainnet.ts  # NEW: Mainnet deployment
├── hardhat.config.ts             # MODIFIED: Add Cronos networks
├── .env.example                  # MODIFIED: Add Cronos variables
└── README.md or docs/deployment.md  # MODIFIED: Add deployment guide
```

**Naming Conventions:**
- Deployment scripts: `deploy-{network}.ts` (e.g., `deploy-cronos-testnet.ts`)
- Network names in config: `{chain}-{network}` (e.g., `cronos-testnet`, `cronos-mainnet`)
- Environment variables: `{CHAIN}_{NETWORK}_{RESOURCE}` (e.g., `CRONOS_TESTNET_CHANNEL_ADDRESS`)

[Source: docs/architecture/source-tree-structure.md, Hardhat conventions]

---

### Environment Variable Configuration

**Required for Deployment:**

1. **PRIVATE_KEY** (required, sensitive)
   - Deployer account private key (64 hex characters, no `0x` prefix)
   - Generate: `npx hardhat account create` or use existing wallet
   - Fund testnet wallet: https://cronos.org/faucet (338 network)
   - Fund mainnet wallet: Purchase CRO on exchange, bridge to Cronos
   - **SECURITY:** Never commit to version control, add to `.gitignore`

2. **CRONOSCAN_API_KEY** (required for verification)
   - Obtain: https://cronoscan.com/myapikey (free account)
   - Used for contract verification after deployment
   - Same key works for both testnet and mainnet

3. **Contract Addresses** (populated after deployment)
   - `CRONOS_TESTNET_MOCK_AKT_ADDRESS`: Deployed MockAKT address (testnet)
   - `CRONOS_TESTNET_CHANNEL_ADDRESS`: Deployed CronosPaymentChannel address (testnet)
   - `CRONOS_MAINNET_AKT_ADDRESS`: Real AKT token address (hardcoded: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`)
   - `CRONOS_MAINNET_CHANNEL_ADDRESS`: Deployed CronosPaymentChannel address (mainnet)

**Example `.env` File:**
```bash
# Cronos Deployment
PRIVATE_KEY=1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
CRONOSCAN_API_KEY=ABCDEFGHIJKLMNOPQRSTUVWXYZ123456

# Testnet (populated after Story 3.4)
CRONOS_TESTNET_MOCK_AKT_ADDRESS=0x...
CRONOS_TESTNET_CHANNEL_ADDRESS=0x...

# Mainnet (populated after Story 3.6)
CRONOS_MAINNET_AKT_ADDRESS=0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3
CRONOS_MAINNET_CHANNEL_ADDRESS=0x...
```

[Source: .env.example structure, Hardhat best practices]

---

### Cronos Network Specifications

**Cronos Testnet:**
- **Network Name:** Cronos Testnet
- **RPC URL:** https://evm-t3.cronos.org:8545/
- **Chain ID:** 338
- **Currency Symbol:** TCRO
- **Block Explorer:** https://testnet.cronoscan.com
- **Faucet:** https://cronos.org/faucet (requires Keplr wallet)
- **Gas Costs:** ~$0.0001 per transaction (very low, funded by faucet)

**Cronos Mainnet:**
- **Network Name:** Cronos Mainnet
- **RPC URL:** https://evm.cronos.org
- **Chain ID:** 25
- **Currency Symbol:** CRO
- **Block Explorer:** https://cronoscan.com
- **Gas Costs:** ~$0.001 per transaction (60-70% cheaper than Base L2)
- **AKT Token Address:** `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3` (bridged from Akash via IBC)

**MetaMask Configuration:**
Both networks can be added to MetaMask automatically by visiting:
- Testnet: Click "Add Network" on https://testnet.cronoscan.com
- Mainnet: Click "Add Network" on https://cronoscan.com

[Source: docs/research/cronos-akt-deployment/findings/deployment-guide.md, Cronos documentation]

---

### Contract Verification Process

**Purpose:** Make contract source code publicly viewable on CronoScan, enabling users to verify contract behavior and interact via block explorer UI.

**Verification Command:**
```bash
# Testnet verification (MockAKT - no constructor args)
npx hardhat verify --network cronos-testnet <MOCK_AKT_ADDRESS>

# Testnet verification (CronosPaymentChannel - with constructor arg)
npx hardhat verify --network cronos-testnet <CHANNEL_ADDRESS> <MOCK_AKT_ADDRESS>

# Mainnet verification (CronosPaymentChannel - with mainnet AKT)
npx hardhat verify --network cronos-mainnet <CHANNEL_ADDRESS> 0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3
```

**Constructor Arguments:**
- **MockAKT:** No constructor arguments (verified with address only)
- **CronosPaymentChannel:** Single argument - AKT token address (testnet: MockAKT address, mainnet: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`)

**Success Indicators:**
- Console output: "Successfully verified contract"
- Green checkmark on CronoScan contract page
- "Contract Source Code Verified" badge visible
- Contract can be interacted with via "Write Contract" tab

**Common Verification Errors:**
1. **"Already verified":** Contract already verified, safe to ignore
2. **"Constructor arguments mismatch":** Check AKT address matches deployment
3. **"API key invalid":** Verify `CRONOSCAN_API_KEY` in `.env`
4. **"Compilation settings mismatch":** Ensure Hardhat config matches deployed bytecode (should not occur if using same config)

[Source: Hardhat verify plugin documentation, Story 3.4 AC]

---

### Testing Strategy for This Story

**Unit Testing:** Not applicable (configuration story, no new code to test)

**Integration Testing:**
1. **Configuration Validation:**
   - Run `npx hardhat config` and verify Cronos networks appear
   - Verify network URLs, chainIds, and gas settings are correct

2. **Compilation Validation:**
   - Run `npx hardhat compile`
   - Verify no errors or warnings
   - Verify TypeChain types generated

3. **Dry-Run Deployment (Optional):**
   - Test deployment scripts on Hardhat local network
   - Verify scripts execute without errors
   - Verify logging output is clear and complete

**Manual Testing Checklist (Story 3.4):**
- Actual testnet deployment will be performed in Story 3.4
- This story only prepares scripts and configuration

[Source: docs/architecture/tech-stack.md#testing-integration]

---

### Known Constraints and Dependencies

**Blockers:**
- Story 3.2 must be complete (test suite validates contract readiness)
- Contracts must compile successfully (verified in Story 3.1, 3.2)

**Prerequisites:**
- Hardhat 2.x installed (from Story 3.1)
- Node.js 22.x LTS installed
- Git installed (for version control)
- Access to CronoScan for API key creation

**External Dependencies:**
- Cronos RPC endpoints must be operational (testnet and mainnet)
- CronoScan API must be available for verification
- Faucet must be operational for testnet deployment (Story 3.4)

**Assumptions:**
- Cronos network is stable and compatible with Hardhat
- CronoScan verification API is free for basic usage
- Real AKT token address on Cronos mainnet is correct: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`
- Deployment scripts will be executed manually (not automated via CI/CD)

**Deferred to Future Stories:**
- Actual testnet deployment (Story 3.4): Deploy and verify contracts on Cronos testnet
- Mainnet deployment (Story 3.6): Deploy to production after all testing complete
- CI/CD automation (Future epic): Automate deployment via GitHub Actions

[Source: docs/prd/epic-3-cosmwasm-payment-channel-contract.md]

---

### Security Considerations

**Private Key Management:**
- Never commit `PRIVATE_KEY` to version control
- Use dedicated deployment wallet (not personal wallet)
- Backup private key securely (hardware wallet or encrypted file)
- Rotate deployment key after mainnet deployment (optional)

**Environment Variable Security:**
- Add `.env` to `.gitignore` (should already be present)
- Use different `.env` files for testnet and mainnet (`.env.testnet`, `.env.mainnet`)
- Restrict file permissions on `.env`: `chmod 600 .env`

**Network Verification:**
- Deployment scripts should log chainId and network name before deployment
- Add confirmation prompt for mainnet deployment to prevent accidental deployment to wrong network

**Gas Estimation:**
- Testnet deployment: Faucet provides sufficient funds (~10 TCRO)
- Mainnet deployment: Estimate gas cost before deployment (~10 CRO buffer recommended)
- Monitor gas price during deployment (high network congestion can increase costs)

**Contract Verification:**
- Verify contracts immediately after deployment
- Check verified source code matches local source code
- Document verification transaction hashes

[Source: docs/architecture/security-architecture.md, Hardhat security best practices]

---

### Documentation Requirements

**README.md or docs/deployment.md Sections:**

1. **Prerequisites:**
   - Software requirements (Node.js, Hardhat, etc.)
   - Account setup (wallet creation, faucet funding)
   - API key acquisition (CronoScan)

2. **Configuration:**
   - Environment variable setup
   - Network configuration verification
   - Compilation validation

3. **Testnet Deployment:**
   - Step-by-step deployment instructions
   - Expected output and transaction hashes
   - Contract verification process
   - Troubleshooting common errors

4. **Mainnet Deployment:**
   - Pre-deployment checklist (audits, testing, funding)
   - Deployment instructions
   - Verification process
   - Post-deployment validation

5. **Troubleshooting:**
   - Common errors and solutions
   - Network connectivity issues
   - Gas estimation problems
   - Verification failures

**Code Comments:**
- Deployment scripts should have clear comments explaining each step
- Hardhat config should document why each setting is chosen
- `.env.example` should have explanatory comments for each variable

[Source: docs/architecture/source-tree-structure.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | Initial story creation for Epic 3 Story 3 | Claude Code (Sonnet 4.5) |
| 2025-11-28 | 1.1 | Implementation complete: Hardhat config, deployment scripts, documentation | James (Dev Agent - Sonnet 4.5) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929[1m])

### Debug Log References

No issues encountered during implementation.

### Completion Notes List

**Story 3.3 successfully completed all acceptance criteria:**

1. **Hardhat Configuration (AC 1-2):**
   - Added Cronos testnet and mainnet network configurations to `hardhat.config.ts`
   - Integrated dotenv for environment variable management
   - Configured etherscan verification with custom chains for Cronos networks
   - Both networks use `PRIVATE_KEY` from `.env` with fallback to empty array

2. **Deployment Scripts (AC 3-4):**
   - Created `scripts/deploy-cronos-testnet.ts` (118 lines)
     - Deploys MockAKT and CronosPaymentChannel
     - Mints 10,000 AKT to deployer for testing
     - Comprehensive logging with transaction hashes
     - Error handling for zero balance and deployment failures
   - Created `scripts/deploy-cronos-mainnet.ts` (145 lines)
     - Uses mainnet AKT address: `0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3`
     - Pre-deployment checks (balance validation, gas estimation)
     - Safety warnings about mainnet deployment costs
     - Post-deployment cost reporting

3. **Environment Configuration (AC 5):**
   - Updated `.env.example` with Cronos deployment variables
   - Added detailed comments explaining each variable
   - Documented API key sources and faucet URLs
   - Included placeholder addresses for testnet and mainnet

4. **Compilation Verification (AC 6):**
   - Contracts compile successfully: `npx hardhat compile`
   - No new compilation errors introduced
   - TypeChain types already generated from Story 3.2
   - Hardhat configuration loads correctly

5. **Documentation (AC 7):**
   - Created comprehensive `docs/deployment.md` (550+ lines)
   - Sections: Prerequisites, Configuration, Testnet Deployment, Mainnet Deployment, Contract Verification, Troubleshooting
   - Step-by-step instructions with expected outputs
   - Security best practices documented
   - Network information and cost estimates included

**Key Implementation Notes:**

- **Security:** Deployment scripts validate network chainId before deployment
- **Gas Estimation:** Mainnet script estimates deployment cost before executing
- **Error Handling:** Both scripts handle insufficient balance, zero balance, deployment failures
- **Logging:** Comprehensive console output with transaction hashes, addresses, and network info
- **Documentation:** Troubleshooting section covers 7 common deployment issues

**Files Ready for Story 3.4 (Testnet Deployment):**
- `scripts/deploy-cronos-testnet.ts` - Ready to execute on Cronos testnet
- `docs/deployment.md` - Step-by-step testnet deployment guide
- `.env.example` - Template for configuring environment variables

**No Blockers or Issues:**
- All tasks completed successfully
- No manual intervention required
- Configuration tested and validated

### File List

**Files Created:**
- `scripts/deploy-cronos-testnet.ts` - Testnet deployment script (118 lines)
- `scripts/deploy-cronos-mainnet.ts` - Mainnet deployment script (145 lines)
- `docs/deployment.md` - Comprehensive deployment guide (550+ lines)

**Files Modified:**
- `hardhat.config.ts` - Added Cronos networks and etherscan verification config
- `.env.example` - Added Cronos deployment environment variables

---

## QA Results

### Review Date: 2025-11-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

Story 3.3 delivers a production-ready configuration with comprehensive deployment automation and exceptional documentation. All acceptance criteria fully met with security best practices embedded throughout.

**Strengths:**
1. **Security-First Design:** Private key validation, balance checks, network verification, mainnet warnings
2. **Developer Experience:** Crystal-clear console output, helpful error messages, comprehensive logging
3. **Documentation Excellence:** 619-line deployment guide covering every scenario, troubleshooting section with 7 common issues
4. **Gas Optimization Awareness:** Mainnet script estimates costs before deployment, reports actual costs after
5. **Configuration Separation:** Clean separation between testnet (MockAKT) and mainnet (real AKT) flows

**Configuration Quality:**
- Hardhat config: Clean, minimal, follows official patterns
- Environment variables: Well-documented with clear comments explaining purpose and sources
- Network configs: Correct RPC URLs, chain IDs, verification endpoints verified against Cronos docs

**Deployment Script Quality:**
- TypeScript with proper types
- Error handling for all critical paths (zero balance, insufficient funds, wrong network)
- Comprehensive logging with transaction hashes for audit trails
- User-friendly "Next Steps" sections guide users post-deployment

### Refactoring Performed

**No refactoring required.** Code quality is exemplary and follows all best practices.

### Compliance Check

- **Coding Standards:** ✓ TypeScript best practices, clear naming, comprehensive comments
- **Project Structure:** ✓ Files in correct locations (`scripts/`, `docs/`, root config files)
- **Testing Strategy:** ✓ Configuration validation via compilation test (AC 6)
- **All ACs Met:** ✓ All 7 acceptance criteria fully satisfied

### Requirements Traceability (Given-When-Then)

**AC 1: Hardhat Configuration with Cronos Networks**
- **Given** Hardhat is installed and configured
- **When** developer runs `npx hardhat config`
- **Then** cronos-testnet and cronos-mainnet networks appear with correct RPC URLs, chain IDs, and PRIVATE_KEY account
- **Coverage:** ✓ Manual validation (hardhat.config.ts:17-28)

**AC 2: CronoScan Verification Configuration**
- **Given** CRONOSCAN_API_KEY is set in .env
- **When** developer runs `npx hardhat verify --network cronos-testnet <ADDRESS>`
- **Then** contract is verified on CronoScan using custom chains configuration
- **Coverage:** ✓ Configuration present (hardhat.config.ts:29-52)

**AC 3: Testnet Deployment Script**
- **Given** deployer has testnet CRO and PRIVATE_KEY configured
- **When** developer runs `npx hardhat run scripts/deploy-cronos-testnet.ts --network cronos-testnet`
- **Then** MockAKT and CronosPaymentChannel are deployed, 10k AKT minted, addresses logged
- **Coverage:** ✓ Script implements all steps (scripts/deploy-cronos-testnet.ts)

**AC 4: Mainnet Deployment Script**
- **Given** deployer has ≥10 CRO and mainnet PRIVATE_KEY configured
- **When** developer runs `npx hardhat run scripts/deploy-cronos-mainnet.ts --network cronos-mainnet`
- **Then** CronosPaymentChannel deployed with AKT address 0x39a65A74Dc5A778Ff93d1765Ea51F57BC49c81B3
- **Coverage:** ✓ Script with pre-deployment checks (scripts/deploy-cronos-mainnet.ts)

**AC 5: .env.example Updated**
- **Given** developer needs to configure deployment
- **When** developer copies .env.example to .env
- **Then** all Cronos variables present with clear comments
- **Coverage:** ✓ Lines 161-184 in .env.example

**AC 6: Compilation Succeeds**
- **Given** Hardhat is configured and contracts exist
- **When** developer runs `npx hardhat compile`
- **Then** contracts compile without errors
- **Coverage:** ✓ Verified during review (command output: "Nothing to compile")

**AC 7: Deployment Documentation**
- **Given** developer needs deployment instructions
- **When** developer reads docs/deployment.md
- **Then** complete guide with prerequisites, steps, verification, troubleshooting
- **Coverage:** ✓ 619-line comprehensive guide (docs/deployment.md)

### Security Review

**✓ PASS - Security Best Practices Implemented**

**Positive Security Findings:**
1. **Private Key Protection:**
   - Clear warnings never to commit PRIVATE_KEY to version control (.env.example:164)
   - Fallback to empty array if PRIVATE_KEY missing (hardhat.config.ts:20, 25)
   - Documentation recommends hardware wallet for mainnet (docs/deployment.md:227)

2. **Network Verification:**
   - Mainnet script explicitly checks chainId === 25 before deployment (deploy-cronos-mainnet.ts:51-53)
   - Prevents accidental deployment to wrong network

3. **Balance Validation:**
   - Testnet: Throws error if balance === 0 (deploy-cronos-testnet.ts:43-45)
   - Mainnet: Requires ≥10 CRO before deployment (deploy-cronos-mainnet.ts:64-69)

4. **Gas Estimation:**
   - Mainnet script estimates gas cost BEFORE deployment (deploy-cronos-mainnet.ts:73-88)
   - Reports actual cost after deployment for transparency (deploy-cronos-mainnet.ts:113-120)

5. **Mainnet Warnings:**
   - Multiple warnings about real funds (deploy-cronos-mainnet.ts:41, 96-97)
   - Security recommendations in output (deploy-cronos-mainnet.ts:138-142)

**No Security Issues Found**

### Performance Considerations

**✓ PASS - Appropriate for Configuration Story**

- Hardhat optimizer enabled with 200 runs (hardhat.config.ts:12-13)
- Deployment scripts use efficient ethers.js v6 APIs
- No performance concerns for one-time deployment scripts

### Non-Functional Requirements (NFRs)

**Security: PASS**
- Private key management: Secure with multiple safeguards
- Network verification: Prevents deployment to wrong network
- Gas estimation: Transparent cost visibility

**Reliability: PASS**
- Error handling: Zero balance, insufficient funds, deployment failures
- Transaction confirmation: Uses `waitForDeployment()` for all contracts
- Logging: Comprehensive transaction hashes for audit trails

**Maintainability: PASS**
- Documentation: Exceptional 619-line deployment guide
- Code clarity: Clear comments explaining each step
- Troubleshooting: 7 common issues documented with solutions

**Usability: PASS**
- Developer experience: Clear console output with step numbers
- Environment setup: .env.example with detailed comments
- Next steps: Post-deployment guidance in script output

### Improvements Checklist

All items handled by Dev Agent - no additional work required:

- [x] Hardhat configuration with Cronos networks (hardhat.config.ts)
- [x] CronoScan verification config with custom chains (hardhat.config.ts)
- [x] Testnet deployment script with MockAKT deployment (scripts/deploy-cronos-testnet.ts)
- [x] Mainnet deployment script with safety checks (scripts/deploy-cronos-mainnet.ts)
- [x] Environment variables documented in .env.example
- [x] Compilation validation (verified during review)
- [x] Comprehensive deployment documentation (docs/deployment.md)

**Future Enhancements (Optional, Not Blocking):**
- [ ] Consider adding `--dry-run` flag to deployment scripts for simulation without actual deployment
- [ ] Consider CI/CD integration for automated testnet deployments (future epic)

### Files Modified During Review

**No files modified during QA review.** All code met quality standards without refactoring.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.3-configure-hardhat-for-cronos-and-create-deployment-scripts.yml

**Quality Score:** 100/100
- Zero blocking issues
- All acceptance criteria fully met
- Security best practices implemented
- Exceptional documentation quality

### Recommended Status

**✓ Ready for Done**

Story 3.3 is production-ready and exceeds quality expectations. All acceptance criteria satisfied, security best practices embedded, comprehensive documentation provided. No changes required.

**Next Story:** Story 3.4 can proceed with testnet deployment using the scripts and documentation created in this story.
